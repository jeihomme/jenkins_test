<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="frontPrdt">

	<!-- 접수내역 목록 조회 -->
	<select id="selectFrontPrdtList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				*,
				PPCV_CODE.CODE_NM AS PRDT_DISC_NM,
				(
					CASE
						WHEN PRDT_CD LIKE '%COACH%' THEN IFNULL( (SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB WHERE PPB.CATE_IDX = SUBSTR(PRDT_CD,9,LENGTH(PRDT_CD) ) AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K' AND PPB.USER_IDX = #{frontLoginIdx} AND ( PRDT_CD LIKE '%CN%' OR PRDT_CD LIKE '%FN%' OR PRDT_CD LIKE '%EN%') ), 'NOJJIM' )
						ELSE IFNULL( (SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB WHERE PPB.BASK_PRDT_CD = PRDT_CD AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K' AND PPB.USER_IDX = #{frontLoginIdx}), 'NOJJIM' )
					END
				) AS JJIM_IDX
			FROM (
					SELECT DISTINCT
						PPV.*,
			-- 			PIP.INFO_PRDT_TITL1,
			-- 			PIP.INFO_PRDT_TITL2,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    
					    ORDER BY
    					PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
			-- 				LEFT JOIN PPM_INFO_PRDT PIP ON PIP.CATE_IDX = PPV.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV ON PSCV.CATE_IDX = PPV.CATE_IDX 
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
			-- 			AND PIP.INFO_USE_YN = 'Y'
			-- 			AND PIP.PRDT_CD = PPV.PRDT_CD
			-- 			AND PIP.INFO_ORDE = 0
						AND PC.CATE_READ_YN = 'Y'
				]]>
					<if test="searchVal not in {null, ''}">
						<if test='searchVal == "VOD" '>
						<![CDATA[
		 				AND PRDT_TYPE LIKE '%VOD%'
		 --				AND PRDT.PRDT_CD LIKE '%VL%'
						]]>
						</if>
						<if test='searchVal == "1:1 코칭" '>
						<![CDATA[
		 				AND PRDT_TYPE LIKE '%1:1%'
		 --				AND (PRDT.PRDT_CD LIKE '%FN%' OR PRDT.PRDT_CD LIKE '%CN%' OR PRDT.PRDT_CD LIKE '%EN%')
						]]>
						</if>
						<if test='searchVal == "LIVE CLASS" '>
						<![CDATA[
						AND PRDT_TYPE LIKE '%LIVE%'
		--				AND PRDT.PRDT_CD LIKE '%LN%'
						]]>
						</if>
					</if>
					<if test="codeNm not in {null, ''}">
						<![CDATA[
						AND P_CODE_NM LIKE '%${codeNm}%'
						]]>
					</if>
				<![CDATA[
				
				
						GROUP BY CATE_IDX
				
			) MAIN
				LEFT JOIN PPM_CODE PPCV_CODE ON PPCV_CODE.CODE_ID = MAIN.PRDT_DISC_CD
			WHERE
				PPCV_CODE.CODE_NM IS NOT NULL
			ORDER BY SALE_PRDT_CD, CATE_ORDR
		]]>
	</select>


	
	
	<!-- 공지사항 목록 조회 -->
	<select id="selectFrontPrdtListCnt" parameterType="hashmap" resultType="int">
		
		<![CDATA[
		
			SELECT
				1
			
	]]>
	</select>
	

	<select id="selectFrontBannprdtList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
			 	BANN_IDX,
				BANN_TYPE, 
				BANN_TITL, 
				BANN_UUID,
				(
					SELECT
						CODE_NM
					FROM
						PPM_CODE
					WHERE
						CODE_ID LIKE '%PRD%'
						
							]]>
						<if test="searchVal in {null, ''}">
							<![CDATA[
							AND CODE_NM LIKE '%VOD%'
							]]>
						</if>
						<if test="searchVal not in {null, ''}">
							<![CDATA[
							AND CODE_NM LIKE '%${searchVal}%'
							]]>
						</if>
						<![CDATA[
						
				) AS  BANN_TYPE_NM, 
				
				BANN_LINK,
				BANN_ORDR,
				BANN_USE_YN
			FROM
				PPM_PRDT_BANN
			WHERE
				BANN_USE_YN ='Y'
				AND BANN_DEL_YN = 'N'
				AND BANN_TYPE = (
									SELECT
										CODE_ID
									FROM
										PPM_CODE
									WHERE
										CODE_ID LIKE '%PRD%'
										]]>
									<if test="searchVal in {null, ''}">
										<![CDATA[
										AND CODE_NM LIKE '%VOD%'
										]]>
									</if>
									<if test="searchVal not in {null, ''}">
										<![CDATA[
										AND CODE_NM LIKE '%${searchVal}%'
										]]>
									</if>
									<![CDATA[
									)
			ORDER BY
				BANN_TYPE, BANN_ORDR, SYS_REG_DTM DESC
		--	LIMIT
		--		1
		]]>
	</select>
	
	

	<!-- 접수내역 목록 조회 -->
	<select id="selectFrontPrdtDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				PIP.PRDT_CD,
				INFO_PRDT_UUID,
				P_CODE.CODE_NM AS P_CODE_NM,
				M_CODE.CODE_NM AS M_CODE_NM,
				
				PC.CATE_IDX,
				PU.USER_NM,
				INFO_PRDT_TITL1,
				INFO_PRDT_TITL2,
				INFO_PRDT_SUBT,
				
				(
					CASE
						WHEN PIP.PRDT_CD LIKE '%VL%' THEN 'VOD'
						WHEN PIP.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						ELSE '1:1 코칭'
					END
				) AS PRDT_TYPE,
				(
					CASE
						WHEN PIP.PRDT_CD LIKE '%VL%' THEN ( SELECT LECT_DTM FROM PPM_PRDT_LECT WHERE LECT_CD = PIP.PRDT_CD )
						WHEN PIP.PRDT_CD LIKE '%LN%' THEN ( SELECT LIVE_CNT FROM PPM_PRDT_LIVE WHERE LIVE_CD = PIP.PRDT_CD )
						WHEN PIP.PRDT_CD LIKE '%CN%' THEN ''
						WHEN PIP.PRDT_CD LIKE '%FN%' THEN ''
						WHEN PIP.PRDT_CD LIKE '%EN%' THEN ( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PIP.PRDT_CD )
					END
				) AS PRDT_CNT,
				(
					CASE
						WHEN PIP.PRDT_CD LIKE '%LN%' THEN ( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_PRDT_CD = PIP.PRDT_CD AND BUY_STAT IN ('결제완료','입금대기' ) )
						ELSE '0'
					END
				) AS PRDT_BUY_CNT,
		
				FORMAT( PRDT_PRIC, 0 ) AS PRDT_PRIC,
				PRDT_DISC_CD,
				PPCV_CODE.CODE_NM AS PRDT_DISC_NM,
				PRDT_DISC,
				FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL,
				
				PPCV.PRDT_CD,
				
				( SELECT COUNT(0) FROM PPM_USER_FOLL WHERE PRDT_CD = PIP.PRDT_CD AND USER_IDX = #{frontLoginIdx } ) AS FOLL_YN,
				( SELECT DISTINCT PRDT_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = PIP.CATE_IDX AND PRDT_CD LIKE '%VL%' ) AS PRDT_CD_VOD,
				( SELECT DISTINCT PRDT_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = PIP.CATE_IDX AND PRDT_CD LIKE '%LN%' ) AS PRDT_CD_LIVE,
				( SELECT DISTINCT PRDT_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = PIP.CATE_IDX AND PRDT_CD LIKE '%CN%' ) AS PRDT_CD_CHAT,
				( SELECT DISTINCT PRDT_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = PIP.CATE_IDX AND PRDT_CD LIKE '%FN%' ) AS PRDT_CD_FACE,
				( SELECT DISTINCT PRDT_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = PIP.CATE_IDX AND PRDT_CD LIKE '%EN%' ) AS PRDT_CD_MAIL,
				(
					CASE
						WHEN PIP.PRDT_CD LIKE '%COACH%' THEN (SELECT COUNT(0) FROM PPM_PRDT_BASK PPB WHERE PPB.CATE_IDX = SUBSTR(PIP.PRDT_CD,9,LENGTH(PIP.PRDT_CD) ) AND  (PPB.BASK_PRDT_CD LIKE '%FN%' OR PPB.BASK_PRDT_CD LIKE '%CN%' OR PPB.BASK_PRDT_CD LIKE '%EN%') AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K' AND PPB.USER_IDX = #{frontLoginIdx} )
						ELSE (SELECT COUNT(0) FROM PPM_PRDT_BASK PPB WHERE BASK_USE_YN = 'Y' AND BASK_TYPE = 'K' AND BASK_PRDT_CD = PIP.PRDT_CD AND USER_IDX = #{frontLoginIdx})
					END
				) AS BASK_YN,
				(
					CASE
						WHEN PIP.PRDT_CD LIKE '%LN%' THEN ( SELECT LIVE_ACAD_YN FROM PPM_PRDT_LIVE WHERE LIVE_CD = PIP.PRDT_CD )
						ELSE ''
					END
				) AS LIVE_ACAD_YN,
				(
					CASE
						WHEN PPCV.PRDT_CD LIKE '%LN%' THEN ( SELECT CONVERT(COUNT(0),CHAR) FROM PPM_PRDT_TIME WHERE LIVE_IDX = PPCV.PRDT_IDX AND TIME_USE_YN = 'Y' )
						ELSE ''
					END
				) AS LIVE_ACAD_CNT,
				(
					CASE
						WHEN PPCV.PRDT_CD LIKE '%LN%' THEN CONCAT( ( SELECT TIME_DTM FROM PPM_PRDT_TIME WHERE LIVE_IDX = PPCV.PRDT_IDX AND TIME_USE_YN = 'Y' ORDER BY TIME_DTM LIMIT 1 ), '~', ( SELECT TIME_DTM FROM PPM_PRDT_TIME WHERE LIVE_IDX = PPCV.PRDT_IDX AND TIME_USE_YN = 'Y' ORDER BY TIME_DTM DESC LIMIT 1 ) )
						ELSE ''
					END
				) AS LIVE_ACAD_DTM,
				
				( SELECT LIVE_ACAD_YN FROM PPM_PRDT_LIVE WHERE LIVE_CD = PIP.PRDT_CD ) AS LIVE_ACAD_YN2,
		
				DATEDIFF(( SELECT PPT.TIME_DTM FROM PPM_PRDT_LIVE PPL, PPM_PRDT_TIME PPT WHERE PPL.LIVE_IDX = PPT.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' AND  PPL.LIVE_CD = PIP.PRDT_CD ORDER BY PPT.TIME_IDX DESC LIMIT 1 ), ( SELECT PPT.TIME_DTM FROM PPM_PRDT_LIVE PPL, PPM_PRDT_TIME PPT WHERE PPL.LIVE_IDX = PPT.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' AND  PPL.LIVE_CD = PIP.PRDT_CD ORDER BY PPT.TIME_IDX ASC LIMIT 1  )) LIVE_DTM,
			
				MAIN_OPEN_YN,
				DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS MAIN_OPEN_DTM,
				IFNULL( DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS MAIN_OPEN_DTM_ORDR,
				SUBMAIN_OPEN_YN,
				DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS SUBMAIN_OPEN_DTM,
				IFNULL(DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS SUBMAIN_OPEN_DTM_ORDR,
				PPCV.PRDT_CD AS PRDT_REG_CD,
				DEAL_DISC_PRIC,
				DEAL_REAL_PRIC
				
				
			FROM
				PPM_INFO_PRDT PIP
					LEFT JOIN PPM_CATE PC
						ON PIP.CATE_IDX = PC.CATE_IDX
					LEFT JOIN PPM_USER PU
						ON PU.USER_IDX = PC.USER_IDX 
					LEFT JOIN PPM_CODE P_CODE
						ON P_CODE.CODE_ID = SUBSTR(PC.CODE_ID,1,5)
					LEFT JOIN PPM_CODE M_CODE
						ON M_CODE.CODE_ID = PC.CODE_ID
					LEFT JOIN PPM_SALE_CD_VIEW PPCV
						ON PIP.PRDT_CD = PPCV.PRDT_CD
					LEFT JOIN PPM_CODE PPCV_CODE
						ON PPCV_CODE.CODE_ID = PPCV.PRDT_DISC_CD
					LEFT OUTER JOIN PPM_TIME_DEAL PM
						ON PM.PRDT_CD = PPCV.PRDT_CD
						AND SUBMAIN_OPEN_YN = 'Y' AND DEAL_DISC_PRIC IS NOT NULL AND DEAL_REAL_PRIC IS NOT NULL
						AND DATEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > -1 AND TIMEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > '00:00:00'
			WHERE
				PIP.PRDT_CD = #{prdtCd }
				AND INFO_USE_YN = 'Y'
				AND PC.CATE_USE_YN = 'Y'
				AND PU.USER_USE_YN = 'Y'
				AND P_CODE.CODE_USE_YN = 'Y'
				AND M_CODE.CODE_USE_YN = 'Y'
				AND PIP.INFO_ORDE = '0'
		]]>
	</select>
	
	<select id="selectFrontPrdtUrlList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		SELECT
			PIP.CATE_IDX,
			PIP.PRDT_CD,
			PU.USER_NM,
			INFO_TITL,
	    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_FACE PPF ON PPT.FACE_IDX = PPF.FACE_IDX
	    		WHERE
						DATEDIFF(TIME_DTM, NOW()) >= 0
						AND TIME_USE_YN = 'Y'
						AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
						AND PPF.CATE_IDX = SUBSTR(PIP.PRDT_CD,9,LENGTH(PIP.PRDT_CD))
	    	) AS FN_TIME_CNT,
	    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_CHAT PPC ON PPT.CHAT_IDX = PPC.CHAT_IDX
	    		WHERE
						DATEDIFF(TIME_DTM, NOW()) >= 0
						AND TIME_USE_YN = 'Y'
						AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
						AND PPC.CATE_IDX = SUBSTR(PIP.PRDT_CD,9,LENGTH(PIP.PRDT_CD))
	    	) AS CN_TIME_CNT,
	    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_LIVE PPL ON PPT.LIVE_IDX = PPL.LIVE_IDX
	    		WHERE
						DATEDIFF(TIME_DTM, NOW()) >= 0
						AND TIME_USE_YN = 'Y'
						AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
						AND PPL.LIVE_CD = PIP.PRDT_CD
	    	) AS LN_TIME_CNT,
			GROUP_CONCAT( SUBSTR(SUBSTR(PSCV.PRDT_CD, 1, 8 ), 7, 2 ) ) AS TIME_PRDT,
			(
				SELECT GROUP_CONCAT( SUBSTR(PRDT_CD,7,2) )
				FROM PPM_INFO_PRDT PIP WHERE PIP.CATE_IDX = PC.CATE_IDX AND PIP.PRDT_CD LIKE '%VL%' AND PIP.INFO_CD = 'PIN01'
			) AS PRDT_VL_CHK
		FROM
			PPM_INFO_PRDT PIP
				LEFT JOIN PPM_CATE PC
					ON PIP.CATE_IDX = PC.CATE_IDX
				LEFT JOIN PPM_USER PU
					ON PU.USER_IDX = PC.USER_IDX 
				LEFT OUTER JOIN PPM_PRDT_VIEW PPV
					ON PPV.CATE_IDX = PC.CATE_IDX
				LEFT JOIN PPM_SALE_CD_VIEW PSCV
					ON PSCV.CATE_IDX = PPV.CATE_IDX
					AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
		WHERE
			INFO_USE_YN = 'Y' 
			AND INFO_ORDE = 0
			]]>
		<if test="cateIdx not in {null, ''}">
			<![CDATA[
			AND PIP.CATE_IDX = #{cateIdx }
			]]>
		</if>
		<if test="cateIdx in {null, ''}">
			<![CDATA[
			AND PIP.CATE_IDX = REPLACE(#{prdtCd }, 'COACHING', '')
			]]>
		</if>
		<![CDATA[
			
			AND PIP.PRDT_CD != #{prdtCd }
		GROUP BY CATE_IDX, PRDT_CD
		]]>
	</select>
	
	<select id="selectFrontPrdtInfoDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				*
			FROM
				PPM_INFO_PRDT
			WHERE
				PRDT_CD = #{prdtCd }
				AND INFO_USE_YN = 'Y'
			ORDER BY
				INFO_ORDE
		]]>
	</select>
	
	<select id="selectFrontPrdtReviList" parameterType="hashmap" resultType="hashmap">
	<if test=" page not in {'', null} ">
		<![CDATA[
	SELECT C.* FROM (
		SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
			SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
		]]>
		</if>
	
		<![CDATA[
			SELECT
				REVI_IDX,
				PUR.BUY_IDX,
				PU.USER_NICK,
				PU.USER_NM,
				DATE_FORMAT(PUR.SYS_REG_DTM, '%Y-%m-%d ') AS SYS_REG_DTM,
				REVI_SCOR,
				REVI_CNTN,
				REVI_PUBL_YN,
				PUR.REVI_UUID,
	
				PRDT.PRDT_NM,
				PRDT.PRDT_TYPE,
	
				(SELECT COUNT(0) FROM PPM_PRDT_BASK PPB WHERE PPB.BASK_TYPE = 'K' AND PPB.CATE_IDX = PUR.CATE_IDX AND PUB.BUY_IDX = PPB.BASK_IDX   ) JJIMCNT
				
				
			FROM
				PPM_USER_REVI PUR
					LEFT JOIN PPM_USER_BUY PUB ON PUR.BUY_IDX = PUB.BUY_IDX
					LEFT JOIN PPM_USER PU ON PUB.USER_IDX = PU.USER_IDX,
					(
							SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, CONCAT('COACHING', PSF.CATE_IDX) BUY_PRDT_CD2, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX
							UNION ALL
								SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, '' BUY_PRDT_CD2, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD,(SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX
							UNION ALL
								SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, CONCAT('COACHING', PSC.CATE_IDX) BUY_PRDT_CD2, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX
							UNION ALL
								SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, CONCAT('COACHING', PSM.CATE_IDX) BUY_PRDT_CD2, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX
							UNION ALL
								SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, '' BUY_PRDT_CD2, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
			WHERE
				PUR.REVI_USE_YN = 'Y'
				AND ( PUB.BUY_PRDT_CD = #{prdtCd }
				OR PRDT.BUY_PRDT_CD2 = #{prdtCd } )
				AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
		]]>
		<if test='sort in { "", null}'>
		<![CDATA[		
					ORDER BY SYS_REG_DTM DESC	
		]]>
		</if>
		<if test='sort in {"star"}'>
		<![CDATA[		
					ORDER BY REVI_SCOR DESC	
		]]>
		</if>
		<if test='sort in {"popular"}'>
		<![CDATA[		
					ORDER BY JJIMCNT DESC	
		]]>
		</if>
		<if test=" page not in {'', null} ">
		<![CDATA[
				) A JOIN (SELECT @rownumA:=0) rownumA 
		]]>		
				<if test='sort in { "", null}'>
				<![CDATA[		
							ORDER BY SYS_REG_DTM ASC	
				]]>
				</if>
				<if test='sort in {"popular"}'>
				<![CDATA[		
							ORDER BY JJIMCNT ASC
				]]>
				</if>
				<if test='sort in {"star"}'>
				<![CDATA[		
							ORDER BY REVI_SCOR ASC	
				]]>
				</if>	
		<![CDATA[				
		) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC DESC
	) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
		]]>
		</if>
	</select>

	<select id="selectFrontPrdtReviListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
		SELECT COUNT(0)
		
		FROM (
		
			SELECT
				REVI_IDX,
				PUR.BUY_IDX,
				PU.USER_NICK,
				PU.USER_NM,
				DATE_FORMAT(PUR.SYS_REG_DTM, '%Y-%m-%d ') AS SYS_REG_DTM,
				REVI_SCOR,
				REVI_CNTN,
				REVI_PUBL_YN,
				PUR.REVI_UUID,
	
				PRDT.PRDT_NM,
				PRDT.PRDT_TYPE,
	
				(SELECT COUNT(0) FROM PPM_PRDT_BASK PPB WHERE PPB.BASK_TYPE = 'K' AND PPB.CATE_IDX = PUR.CATE_IDX AND PUB.BUY_IDX = PPB.BASK_IDX   ) JJIMCNT
				
				
			FROM
				PPM_USER_REVI PUR
					LEFT JOIN PPM_USER_BUY PUB ON PUR.BUY_IDX = PUB.BUY_IDX
					LEFT JOIN PPM_USER PU ON PUB.USER_IDX = PU.USER_IDX,
					(
							SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, CONCAT('COACHING', PSF.CATE_IDX) BUY_PRDT_CD2, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX
							UNION ALL
								SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, '' BUY_PRDT_CD2, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD,(SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX
							UNION ALL
								SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, CONCAT('COACHING', PSC.CATE_IDX) BUY_PRDT_CD2, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX
							UNION ALL
								SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, CONCAT('COACHING', PSM.CATE_IDX) BUY_PRDT_CD2, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX
							UNION ALL
								SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, '' BUY_PRDT_CD2, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
								FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
			WHERE
				PUR.REVI_USE_YN = 'Y'
				AND ( PUB.BUY_PRDT_CD = #{prdtCd }
				OR PRDT.BUY_PRDT_CD2 = #{prdtCd } )
				AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
			
		
		) A
		]]>
	</select>
	

	<insert id="insertFrontReviewRepot" parameterType="hashmap">
	<![CDATA[
		INSERT INTO PPM_USER_REVI_REPO
			(
			REVI_IDX, 
			USER_IDX, 
			REPO_CNTN,
			REPO_USE_YN, 
			SYS_REG_IDX, 
			SYS_REG_DTM, 
			SYS_MOD_IDX, 
			SYS_MOD_DTM
			)
			
			VALUES
			(
			#{reviIdx}, 
			#{frontLoginIdx}, 
			#{repoCntn}, 
			'Y', 
			#{frontLoginIdx}, 
			DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S'), 
			#{frontLoginIdx}, 
			DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S')
			)
		]]>
	</insert>
	
	
	
	<select id="selectFrontUserHaveReport" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT 
				COUNT(0) CNT
				FROM 
					PPM_USER_REVI_REPO PURR 
						WHERE 
							USER_IDX = #{userIdx}
							AND PURR.REVI_IDX = #{reviIdx}
							AND PURR.REPO_USE_YN = 'Y'
		]]>
	</select>
	
	
	<select id="selectFrontPrdtLectList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		SELECT
			PPLD.DATA_ORDE AS PPLD_DATA_ORDE,
			PPVD.DATA_PART_IDX,
			PPVD.DATA_PART_NM,
			DATA_TITL,
			DATA_FREE_YN,
			PPVD.DATA_ORDE AS PPVD_DATA_ORDE,
			LECT_CD AS PRDT_CD
		FROM
			PPM_PRDT_LECT PPL
				LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX
				LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
				LEFT JOIN PPM_PRDT_VOD PPV ON PPV.VOD_IDX = PPVD.VOD_IDX 
		WHERE
			PPL.LECT_USE_YN = 'Y'
			AND PPLD.DATA_USE_YN = 'Y'
			AND PPVD.DATA_USE_YN = 'Y'
			AND PPV.VOD_USE_YN = 'Y'
			AND PPL.LECT_CD = #{prdtCd }
		ORDER BY
			CONVERT( PPLD.DATA_ORDE, UNSIGNED ), CONVERT( DATA_PART_IDX , UNSIGNED ), CONVERT( PPVD.DATA_ORDE , UNSIGNED )
		]]>
	</select>
	
	
	
	<select id="selectFrontPrdtRecoList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
SELECT DISTINCT
	*
FROM (

	(SELECT DISTINCT
		P_CODE.CODE_NM,
		PU.USER_NM,
		PRDT.CATE_IDX,
		PIP.PRDT_CD,
		(
			CASE
				WHEN PIP.PRDT_CD LIKE '%VL%' THEN 'VOD'
				WHEN PIP.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
				ELSE '1:1 코칭'
			END
		) AS PRDT_TYPE,
		INFO_PRDT_TITL1,
		INFO_PRDT_TITL2,
		FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL,
		FORMAT( PRDT_PRIC, 0 ) AS PRDT_PRIC,
		(
			CASE
				WHEN PRDT_DISC_CD = 'DIS01' THEN PRDT_DISC
				ELSE FORMAT( PRDT_DISC, 0 )
			END
		) AS PRDT_DISC,
		PRDT_DISC_CD,
		INFO_TUMB_UUID,
		'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
		IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND BASK_PRDT_CD = PRDT.PRDT_CD  ), 0 ) BASK_IDX,
    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_FACE PPF ON PPT.FACE_IDX = PPF.FACE_IDX
    		WHERE
					DATEDIFF(TIME_DTM, NOW()) >= 0
					AND TIME_USE_YN = 'Y'
					AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
					AND PPF.CATE_IDX = SUBSTR(PIP.PRDT_CD,9,LENGTH(PIP.PRDT_CD))
    	) AS FN_TIME_CNT,
    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_CHAT PPC ON PPT.CHAT_IDX = PPC.CHAT_IDX
    		WHERE
					DATEDIFF(TIME_DTM, NOW()) >= 0
					AND TIME_USE_YN = 'Y'
					AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
					AND PPC.CATE_IDX = SUBSTR(PIP.PRDT_CD,9,LENGTH(PIP.PRDT_CD))
    	) AS CN_TIME_CNT,
    	(SELECT COUNT( 0 ) FROM PPM_PRDT_TIME PPT LEFT JOIN PPM_PRDT_LIVE PPL ON PPT.LIVE_IDX = PPL.LIVE_IDX
    		WHERE
					DATEDIFF(TIME_DTM, NOW()) >= 0
					AND TIME_USE_YN = 'Y'
					AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
					AND PPL.LIVE_CD = PIP.PRDT_CD
    	) AS LN_TIME_CNT,
		GROUP_CONCAT( SUBSTR(SUBSTR(PRDT.PRDT_CD, 1, 8 ), 7, 2 ) ) AS TIME_PRDT,
		(
			SELECT GROUP_CONCAT( SUBSTR(PRDT_CD,7,2) )
			FROM PPM_INFO_PRDT PIP WHERE PIP.CATE_IDX = PC.CATE_IDX AND PIP.PRDT_CD LIKE '%VL%' AND PIP.INFO_CD = 'PIN01'
		) AS PRDT_VL_CHK
	FROM
		PPM_SALE_CD_VIEW PRDT
			LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
			LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
			LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
			LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
			LEFT JOIN PPM_INFO_PRDT PIP ON PRDT.CATE_IDX = PIP.CATE_IDX
	WHERE
		PIP.CATE_IDX IN ( SELECT CATE_IDX FROM PPM_CATE PC WHERE CATE_IDX = #{cateIdx} AND  CATE_USE_YN = 'Y') AND PIP.PRDT_CD != #{prdtCd }
		AND PIP.INFO_ORDE = 0
		AND PIP.INFO_USE_YN = 'Y'
		AND PRDT_DISC_CD != 'DIS02'
	GROUP BY CATE_IDX, PRDT_CD
	ORDER BY PRDT_PRIC_REAL, PRDT_DISC_CD)
	      
UNION ALL

	(SELECT DISTINCT
		P_CODE.CODE_NM,
		PU.USER_NM,
		PRDT.CATE_IDX,
		PIP.PRDT_CD,
		(
			CASE
				WHEN PIP.PRDT_CD LIKE '%VL%' THEN 'VOD'
				WHEN PIP.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
				ELSE '1:1 코칭'
			END
		) AS PRDT_TYPE,
		INFO_PRDT_TITL1,
		INFO_PRDT_TITL2,
		FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL,
		FORMAT( PRDT_PRIC, 0 ) AS PRDT_PRIC,
		(
			CASE
				WHEN PRDT_DISC_CD = 'DIS01' THEN PRDT_DISC
				ELSE FORMAT( PRDT_DISC, 0 )
			END
		) AS PRDT_DISC,
		PRDT_DISC_CD,
		INFO_TUMB_UUID,
		'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
		IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND BASK_PRDT_CD = PRDT.PRDT_CD  ), 0 ) BASK_IDX,
    	1 AS FN_TIME_CNT,
    	1 AS CN_TIME_CNT,
    	1 AS LN_TIME_CNT,
		'CN,EN,FN,LN,VL' AS TIME_PRDT,
		(
			SELECT GROUP_CONCAT( SUBSTR(PRDT_CD,7,2) )
			FROM PPM_INFO_PRDT PIP WHERE PIP.CATE_IDX = PC.CATE_IDX AND PIP.PRDT_CD LIKE '%VL%' AND PIP.INFO_CD = 'PIN01'
		) AS PRDT_VL_CHK
	FROM
		PPM_SALE_CD_VIEW PRDT
			LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
			LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
			LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
			LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
			LEFT JOIN PPM_INFO_PRDT PIP ON PRDT.CATE_IDX = PIP.CATE_IDX
	WHERE 
		PIP.PRDT_CD IN (SELECT DISTINCT PRDT_CD FROM PPM_USER_LOG PUL WHERE ( SYS_REG_IDX = #{frontLoginIdx} OR CATE_IDX IN ( ${userCateLog} ) ) AND PRDT_CD IS NOT NULL AND PRDT_CD != #{prdtCd})
		AND PIP.INFO_ORDE = 0
		AND PIP.INFO_USE_YN = 'Y'
	ORDER BY PRDT_DISC_CD
	LIMIT 4
		  )
UNION ALL 

	(SELECT
		*
	FROM (   
		SELECT DISTINCT
			P_CODE.CODE_NM,
			PU.USER_NM,
			PRDT.CATE_IDX,
			PIP.PRDT_CD,
			(
				CASE
					WHEN PIP.PRDT_CD LIKE '%VL%' THEN 'VOD'
					WHEN PIP.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
					ELSE '1:1 코칭'
				END
			) AS PRDT_TYPE,
			INFO_PRDT_TITL1,
			INFO_PRDT_TITL2,
			FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL,
			FORMAT( PRDT_PRIC, 0 ) AS PRDT_PRIC,
		(
			CASE
				WHEN PRDT_DISC_CD = 'DIS01' THEN PRDT_DISC
				ELSE FORMAT( PRDT_DISC, 0 )
			END
		) AS PRDT_DISC,
		PRDT_DISC_CD,
			INFO_TUMB_UUID,
			'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
			IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND BASK_PRDT_CD = PRDT.PRDT_CD  ), 0 ) BASK_IDX,
	    	1 AS FN_TIME_CNT,
	    	1 AS CN_TIME_CNT,
	    	1 AS LN_TIME_CNT,
			'CN,EN,FN,LN,VL' AS TIME_PRDT,
			(
				SELECT GROUP_CONCAT( SUBSTR(PRDT_CD,7,2) )
				FROM PPM_INFO_PRDT PIP WHERE PIP.CATE_IDX = PC.CATE_IDX AND PIP.PRDT_CD LIKE '%VL%' AND PIP.INFO_CD = 'PIN01'
			) AS PRDT_VL_CHK
		FROM
			PPM_SALE_CD_VIEW PRDT
				LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
				LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
				LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
				LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
				LEFT JOIN PPM_INFO_PRDT PIP ON PRDT.CATE_IDX = PIP.CATE_IDX
		WHERE 
			PRDT.CATE_IDX IN (
						SELECT DISTINCT CATE_IDX FROM PPM_USER PU, PPM_CATE PC
							WHERE
							  LENGTH(USER_KEYW) > 0
							  AND INSTR(PU.USER_KEYW,PC.CODE_ID) > 0
							  AND PC.CATE_USE_YN = 'Y'
							  AND PU.USER_IDX = #{frontLoginIdx}
				)
			AND PIP.INFO_ORDE = 0
			AND PIP.INFO_USE_YN = 'Y'
		ORDER BY BASK_IDX DESC
	) SUB
	ORDER BY PRDT_DISC_CD
)
	
UNION ALL

	(SELECT
		*
	FROM (
		SELECT DISTINCT
			P_CODE.CODE_NM,
			PU.USER_NM,
			PRDT.CATE_IDX,
			PIP.PRDT_CD,
			(
				CASE
					WHEN PIP.PRDT_CD LIKE '%VL%' THEN 'VOD'
					WHEN PIP.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
					ELSE '1:1 코칭'
				END
			) AS PRDT_TYPE,
			INFO_PRDT_TITL1,
			INFO_PRDT_TITL2,
			FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL,
			FORMAT( PRDT_PRIC, 0 ) AS PRDT_PRIC,
		(
			CASE
				WHEN PRDT_DISC_CD = 'DIS01' THEN PRDT_DISC
				ELSE FORMAT( PRDT_DISC, 0 )
			END
		) AS PRDT_DISC,
		PRDT_DISC_CD,
			INFO_TUMB_UUID,
			'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
			IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND BASK_PRDT_CD = PRDT.PRDT_CD  ), 0 ) BASK_IDX,
	    	1 AS FN_TIME_CNT,
	    	1 AS CN_TIME_CNT,
	    	1 AS LN_TIME_CNT,
			'CN,EN,FN,LN,VL' AS TIME_PRDT,
			(
				SELECT GROUP_CONCAT( SUBSTR(PRDT_CD,7,2) )
				FROM PPM_INFO_PRDT PIP WHERE PIP.CATE_IDX = PC.CATE_IDX AND PIP.PRDT_CD LIKE '%VL%' AND PIP.INFO_CD = 'PIN01'
			) AS PRDT_VL_CHK
		FROM
			PPM_SALE_CD_VIEW PRDT
				LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
				LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
				LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID	
				LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
				LEFT JOIN PPM_INFO_PRDT PIP ON ( PIP.PRDT_CD = CONCAT( 'COACHING' , PRDT.CATE_IDX ) OR PIP.PRDT_CD = PRDT.PRDT_CD ) 
		WHERE 
			PRDT.CATE_IDX IN (
				SELECT CATE_IDX FROM PPM_CATE PC
				WHERE PC.CODE_ID = ( SELECT PC2.CODE_ID FROM PPM_CATE PC2 WHERE PC2.CATE_IDX = #{cateIdx} )
				AND  CATE_USE_YN = 'Y'
				AND CATE_IDX !=  #{cateIdx}
			)
			AND PIP.INFO_ORDE = 0
			AND PIP.INFO_USE_YN = 'Y'
		ORDER BY PRDT_PRIC_REAL
		) SUB
		GROUP BY PRDT_CD
		ORDER BY CATE_IDX, PRDT_CD, PRDT_DISC_CD, PRDT_PRIC_REAL
	)
	ORDER BY PRDT_DISC_CD
) MAIN

GROUP BY PRDT_CD

LIMIT 8
		]]>
	</select>
	
	
	<select id="selectFrontPrdtBuyDetail" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	SELECT
		PRDT.CATE_IDX,
		PRDT.PRDT_CD,
		INFO_PRDT_TITL1,
		INFO_PRDT_TITL2,
		PU.USER_NM ,
		P_CODE.CODE_NM AS P_CODE_NM,
		M_CODE.CODE_NM AS M_CODE_NM,
		(
			CASE
				WHEN PRDT.PRDT_CD LIKE '%VL%' THEN ( SELECT LECT_DTM FROM PPM_PRDT_LECT WHERE LECT_CD = PRDT.PRDT_CD )
				WHEN PRDT.PRDT_CD LIKE '%EN%' THEN ( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD )
				WHEN PRDT.PRDT_CD LIKE '%FN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE FACE_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
				WHEN PRDT.PRDT_CD LIKE '%CN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE CHAT_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
				WHEN PRDT.PRDT_CD LIKE '%LN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE LIVE_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
			END
		) AS PRDT_CNT,
		
		
		( SELECT MAIL_DTM_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ) AS MAIL_DTM_CNT,
		
		(
			SELECT PPL.LECT_DTM FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'  AND PPL.LECT_USE_YN = 'Y' LIMIT 1
		) AS LECT_DTM,
		
		(
			SELECT COUNT(0) FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'
		) AS LECT_TOTAL_CNT,
		
		(
			SELECT SUM(DATA_RUNN) FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'
		) AS LECT_TOTAL_MIN_CNT,
		
		DATE_FORMAT(NOW(), '%Y년 %m월 %d일') AS SYS_REG_DTM,
		(
			case WEEKDAY( NOW() ) 
			    when '0' then '월'
			    when '1' then '화'
			    when '2' then '수'
			    when '3' then '목'
			    when '4' then '금'
			    when '5' then '토'
			    when '6' then '일'
			END
		) AS SYS_REG_DTM_WEEK,
		FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL
	FROM
		PPM_SALE_CD_VIEW PRDT
			LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
			LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
			LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
			LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
			LEFT JOIN PPM_INFO_PRDT PIP ON PIP.CATE_IDX = PC.CATE_IDX
	WHERE
		PRDT.CATE_IDX IN ( SELECT CATE_IDX FROM PPM_CATE PC WHERE CATE_IDX = #{cateIdx } AND CATE_USE_YN = 'Y')
		AND PIP.INFO_USE_YN = 'Y'
		AND PIP.INFO_ORDE = '0'
		AND PRDT.PRDT_CD = #{prdtCd }
		AND PIP.INFO_PRDT_TITL1 = 
		CASE 
			WHEN #{prdtCd } LIKE '%LN%' OR #{prdtCd } LIKE '%VL%' THEN (SELECT PIP2.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP2 WHERE PIP2.PRDT_CD = #{prdtCd } AND PIP2.INFO_ORDE  = 0 AND PIP2.INFO_USE_YN= 'Y' ) 
			ELSE (SELECT PIP2.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP2 WHERE PIP2.PRDT_CD = CONCAT('COACHING', PRDT.CATE_IDX ) AND PIP2.INFO_ORDE  = 0 AND PIP2.INFO_USE_YN= 'Y' ) 
		END 
		]]>
	<if test="now not in { null, ''}">
		<![CDATA[
		AND REPLACE(PIP.PRDT_CD, 'COACHING','') = PC.CATE_IDX
		]]>
	</if>
	</select>
	
	<select id="selectFrontPrdtBuyTimeList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT
				TIME_IDX,
				LIVE_IDX,
				FACE_IDX,
				CHAT_IDX,
				DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) TIME_DTM,
				TIME_STR,
				(
					CASE
						WHEN #{prdtCd } LIKE '%FN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE FACE_IDX = FACE_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
						WHEN #{prdtCd } LIKE '%CN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE CHAT_IDX = CHAT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
						WHEN #{prdtCd } LIKE '%LN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE LIVE_IDX = LIVE_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
					END
				) AS PRDT_CNT,
				(
					CASE WEEKDAY( TIME_DTM ) 
					    WHEN '0' THEN '월'
					    WHEN '1' THEN '화'
					    WHEN '2' THEN '수'
					    WHEN '3' THEN '목'
					    WHEN '4' THEN '금'
					    WHEN '5' THEN '토'
					    WHEN '6' THEN '일'
					END
				) AS TIME_DTM_WEEK,
				(SELECT COUNT(0) 
					FROM PPM_USER_BUY PUB 
					
						WHERE 
							PUB.TIME_IDX = PPM_PRDT_TIME.TIME_IDX 
							AND 
							(
								( DATEDIFF( NOW() ,PUB.SYS_REG_DTM ) < 3 AND PUB.BUY_STAT = '입금대기' ) 
								OR ( PUB.BUY_STAT = '결제완료' AND BUY_COMP_YN = 'Y' AND BUY_REFU_YN = 'N' )
							
							)
				) BUY_CNT,
				CASE 
					WHEN #{prdtCd } LIKE '%LN%' THEN (SELECT PPL.LIVE_CNT FROM PPM_PRDT_LIVE PPL WHERE PPL.LIVE_CD = #{prdtCd } )
					ELSE 'N'
				END LIVE_CNT
			FROM	
				PPM_PRDT_TIME
			WHERE
				(
					CHAT_IDX = ( SELECT CHAT_IDX FROM PPM_PRDT_CHAT WHERE CHAT_CD = #{prdtCd } )
					OR LIVE_IDX = ( SELECT LIVE_IDX FROM PPM_PRDT_LIVE WHERE LIVE_CD = #{prdtCd } )
					OR FACE_IDX = ( SELECT FACE_IDX FROM PPM_PRDT_FACE WHERE FACE_CD = #{prdtCd } )
				)
				AND DATEDIFF(TIME_DTM, NOW()) >= 0
				AND TIME_USE_YN = 'Y'
				AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
				]]>
			<if test="timeDtm not in {null, ''}">
				<![CDATA[
				AND DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = DATE_FORMAT(  #{timeDtm }, '%Y-%m-%d' )
				]]>
			</if>
		<![CDATA[
		
				
			ORDER BY
				TIME_DTM, TIME_STR
			-- LIMIT 7
		]]>
	</select>
	
	<select id="selectFrontPrdtBuyQuesList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT
				QUES_CNTN,
				QUES_IDX	
			FROM
				PPM_PRDT_QUES PPQ
			-- 		LEFT JOIN PPM_PRDT_QUES_DATA PPQD ON PPQ.QUES_IDX = PPQD.QUES_IDX
			WHERE
				(
					PPQ.CHAT_IDX = ( SELECT CHAT_IDX FROM PPM_PRDT_CHAT WHERE CHAT_CD = #{prdtCd } )
					OR PPQ.LIVE_IDX = ( SELECT LIVE_IDX FROM PPM_PRDT_LIVE WHERE LIVE_CD = #{prdtCd } )
					OR PPQ.FACE_IDX = ( SELECT FACE_IDX FROM PPM_PRDT_FACE WHERE FACE_CD = #{prdtCd } )
				)
				AND PPQ.QUES_USE_YN = 'Y'
			-- 	AND PPQD.DATA_USE_YN = 'Y'
			-- 	AND PPQD.USER_IDX = 4
			ORDER BY
				PPQ.QUES_IDX
		]]>
	</select>
	

	<insert id="insertFrontPrdtQuesData" parameterType="hashmap">
	<![CDATA[
		INSERT INTO
			PPM_PRDT_QUES_DATA
			(
				QUES_IDX, 
				USER_IDX, 
				DATA_CNTN,
				DATA_USE_YN, 
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX, 
				SYS_MOD_DTM
			) VALUES (
				#{quesIdx}, 
				#{frontLoginIdx}, 
				#{dataCntn}, 
				'Y', 
				
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S'), 
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S')
			)
		]]>
	</insert>
	
	<insert id="insertFrontJjimDataDuple" parameterType="hashmap">
		<![CDATA[
			INSERT INTO 
				PPM_PRDT_BASK
				(
				BASK_PRDT_CD,
				USER_IDX,
				CATE_IDX, 
				BASK_TYPE, 
				BASK_USE_YN,
				BASK_CNT,
				SYS_REG_IDX, 
				SYS_REG_DTM,
				SYS_MOD_IDX,
				SYS_MOD_DTM
				)
				VALUES(
				#{baskPrdtCd}, 
				#{frontLoginIdx}, 
				#{cateIdx},
				#{baskType}, 
				'Y',
				#{baskCnt},
				#{frontLoginIdx}, 
				DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
				#{frontLoginIdx}, 
				DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' )
				)
		]]>
	</insert>

	<update id="updateFrontJjimData" parameterType="hashmap">
		<![CDATA[
			UPDATE  
				PPM_PRDT_BASK
				SET
					BASK_USE_YN = #{baskUseYn},	
					BASK_CNT = #{baskCnt},
					SYS_MOD_IDX = #{frontLoginIdx},
					SYS_MOD_DTM = DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' )
					WHERE
						BASK_PRDT_CD = #{baskPrdtCd}
						AND CATE_IDX = #{cateIdx}
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = #{baskType}
						AND SYS_REG_IDX = #{frontLoginIdx}
		
		]]>
	</update>

		<select id="selectFrontPrdtDataList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		SELECT PRDT.* ,
			
			IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND PPM_PRDT_BASK.BASK_PRDT_CD = PRDT.PRDT_CD), 0 ) BASK_IDX,
			IFNULL( (SELECT BASK_IDX FROM PPM_PRDT_BASK WHERE BASK_TYPE = 'K' AND BASK_USE_YN = 'Y' AND USER_IDX = #{frontLoginIdx} AND PPM_PRDT_BASK.BASK_PRDT_CD = PRDT.PRDT_CD2), 0 ) BASK_IDX2,
			(
				SELECT
					COUNT(0)
				FROM	
					PPM_PRDT_TIME
				WHERE
					(
						CHAT_IDX = ( SELECT CHAT_IDX FROM PPM_PRDT_CHAT WHERE CHAT_CD = PRDT.PRDT_CD2 )
						OR LIVE_IDX = ( SELECT LIVE_IDX FROM PPM_PRDT_LIVE WHERE LIVE_CD = PRDT.PRDT_CD2 )
						OR FACE_IDX = ( SELECT FACE_IDX FROM PPM_PRDT_FACE WHERE FACE_CD = PRDT.PRDT_CD2 )
					)
					AND DATEDIFF(TIME_DTM, NOW()) >= 0
					AND TIME_USE_YN = 'Y'
					AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
				ORDER BY TIME_DTM, TIME_STR
			) AS TIME_CNT,
			
			MAIN_OPEN_YN,
			DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS MAIN_OPEN_DTM,
			IFNULL( DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS MAIN_OPEN_DTM_ORDR,
			SUBMAIN_OPEN_YN,
			DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS SUBMAIN_OPEN_DTM,
			IFNULL(DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS SUBMAIN_OPEN_DTM_ORDR,
			PRDT.PRDT_CD2 AS PRDT_REG_CD,
			DEAL_DISC_PRIC,
			DEAL_REAL_PRIC
			
			
			FROM 
				(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT PPT.TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, CONCAT( 'COACHING', PPF.CATE_IDX ) AS PRDT_CD, PPF.FACE_CD AS PRDT_CD2, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
					FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y' AND PPF.FACE_STAT_CD = 'SAL02'
			UNION ALL
					SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD, PPLE.LECT_CD AS PRDT_CD2, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
					FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y' AND PPLE.LECT_STAT_CD = 'SAL02'
			UNION ALL
					SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT PPT.TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, CONCAT( 'COACHING', PPC.CATE_IDX ) AS PRDT_CD, PPC.CHAT_CD AS PRDT_CD2, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
					FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y' AND PPC.CHAT_STAT_CD = 'SAL02'
			UNION ALL
					SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CNT AS PRDT_TIME, CONCAT( 'COACHING', PPM.CATE_IDX ) AS PRDT_CD, PPM.MAIL_CD AS PRDT_CD2, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
					FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y' AND PPM.MAIL_STAT_CD = 'SAL02'
			UNION ALL
					SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT PPT.TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, PPLI.LIVE_CD AS PRDT_CD2, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
					FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y' AND PPLI.LIVE_STAT_CD = 'SAL02'
				) PRDT
					LEFT OUTER JOIN PPM_TIME_DEAL PM
						ON PM.PRDT_CD = PRDT.PRDT_CD2
						AND SUBMAIN_OPEN_YN = 'Y' AND DEAL_DISC_PRIC IS NOT NULL AND DEAL_REAL_PRIC IS NOT NULL
						AND DATEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > -1 AND TIMEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > '00:00:00',
				PPM_CATE PC
				WHERE PRDT.CATE_IDX = PC.CATE_IDX 
				AND PRDT.CATE_IDX  = #{cateIdx}
	]]>
	<choose>
		<when test='prdtType == "VOD" '>
	<![CDATA[
			AND PRDT.PRDT_CD LIKE '%VL%'
	]]>
		</when>
		<when test='prdtType == "LIVE"'>
	<![CDATA[
			AND PRDT.PRDT_CD LIKE '%LN%'
	]]>
		</when>
		<otherwise>
	<![CDATA[
			AND (
					PRDT.PRDT_CD2 LIKE '%FN%' 
					OR PRDT.PRDT_CD2 LIKE '%CN%'
					OR PRDT.PRDT_CD2 LIKE '%EN%'
					)
	]]>
		</otherwise>	
	</choose>
	</select>
	
<select id="selectUserBuyTimeIdx" parameterType="hashmap" resultType="hashmap">
<![CDATA[
	SELECT 
			(SELECT CONCAT( TIME_DTM, ' ', TIME_STR ) FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_IDX = #{timeIdx} ) NO_TIME,	
			(SELECT CONCAT( PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP 
				WHERE PIP.PRDT_CD = ( CASE 
				WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN CONCAT( 'COACHING',PUB.CATE_IDX ) 
				WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN CONCAT( 'COACHING',PUB.CATE_IDX ) 
				WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN PUB.BUY_PRDT_CD
			END ) AND PIP.INFO_ORDE = 0 ) NO_TITL,
			
			(SELECT LIVE_CNT FROM PPM_PRDT_LIVE WHERE LIVE_CD = PUB.BUY_PRDT_CD ) LIVE_CNT

		
		FROM PPM_USER_BUY PUB 
			WHERE PUB.BUY_PRDT_CD = #{prdtCd} AND PUB.TIME_IDX = #{timeIdx}
			AND ( PUB.BUY_STAT = '결제완료' OR ( PUB.BUY_STAT = '입금대기' AND DATEDIFF( NOW(), PUB.SYS_REG_DTM ) < 3 ) )
]]>
</select>	
	
	
	

	<insert id="insertFrontUserPrdtLogData" parameterType="hashmap">
	<![CDATA[
		INSERT INTO
			PPM_USER_LOG
		(
			LOG_URL, 
			CATE_IDX, 
			PRDT_CD,
			
			SYS_REG_IDX, 
			SYS_REG_DTM
		) VALUES (
			#{logUrl}, 
			#{cateIdx}, 
			#{prdtCd}, 
			 
			#{frontLoginIdx}, 
			DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S')
		)
		]]>
	</insert>
	
	<select id="selectFrontBaskData" parameterType="hashmap" resultType="hashmap"> 
	<![CDATA[
		SELECT  
				
				*
				
			FROM	
				PPM_PRDT_BASK
				
					WHERE
						BASK_PRDT_CD = #{baskPrdtCd}
						AND CATE_IDX = #{cateIdx}
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = #{baskType}
						AND SYS_REG_IDX = #{frontLoginIdx}
	
		]]>
	</select>	
	
	<select id="selectFrontJjimCoachPrdtCd" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		SELECT
			CATE_IDX,
			PRDT_IDX,
			PRDT_CD
		
			FROM 
				PPM_SALE_CD_VIEW PSCV 
				WHERE 
				CATE_IDX = #{cateIdx}
				AND 
				( PRDT_CD LIKE '%CN%'
				OR PRDT_CD LIKE '%EN%'
				OR PRDT_CD LIKE '%FN%' )
		]]>
	</select>
	
	
	<select id="selectMainMdpickList" resultType="hashmap" parameterType="hashmap">
	<![CDATA[
			SELECT
				*,
				(
					CASE
						WHEN PRDT_CD LIKE '%COACH%'
						THEN IFNULL( (
							SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB
							WHERE PPB.CATE_IDX = SUBSTR(PRDT_CD,9,LENGTH(PRDT_CD) )
							AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K'
							AND PPB.USER_IDX = #{frontLoginIdx}
							AND ( PRDT_REG_CD LIKE '%CN%' OR PRDT_REG_CD LIKE '%FN%' OR PRDT_REG_CD LIKE '%EN%')
							AND ( BASK_PRDT_CD = PRDT_CD OR BASK_PRDT_CD = PRDT_REG_CD ) ), 'NOJJIM' )
						ELSE IFNULL( (SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB WHERE PPB.BASK_PRDT_CD = PRDT_CD AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K' AND PPB.USER_IDX = #{frontLoginIdx}), 'NOJJIM' )
					END
				) AS JJIM_IDX
			FROM (
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						IFNULL(MAIN_OPEN_ORDR,9999) AS MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%VOD%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						IFNULL(MAIN_OPEN_ORDR,9999) AS MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%1:1%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' ) OR PRDT_TYPE3 LIKE '%EN%'
				
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						IFNULL(MAIN_OPEN_ORDR,9999) AS MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%LIVE%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' )
			) LIST
			WHERE
				CATE_IDX IS NOT NULL
				AND MAIN_OPEN_YN = 'Y'
				
		]]>
			<if test="searchVal not in {null, ''}">
				<if test='searchVal == "VOD" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%VOD%'
				]]>
				</if>
				<if test='searchVal == "1:1 코칭" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%1:1%'
				]]>
				</if>
				<if test='searchVal == "LIVE CLASS" '>
				<![CDATA[
				AND PRDT_TYPE LIKE '%LIVE%'
				]]>
				</if>
			</if>
		<![CDATA[
			ORDER BY MAIN_OPEN_ORDR, P_CODE_NM
		]]>
	</select>
	
	<select id="selectMainTimedealList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.*, REPLACE(CONVERT(C.NUM_DESC, CHAR),'.0','') AS NUM_DESC_ORDER FROM (
  SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
    SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
			SELECT
				*,
				(
					CASE
						WHEN PRDT_CD LIKE '%COACH%'
						THEN IFNULL( (
							SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB
							WHERE PPB.CATE_IDX = SUBSTR(PRDT_CD,9,LENGTH(PRDT_CD) )
							AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K'
							AND PPB.USER_IDX = #{frontLoginIdx}
							AND ( PRDT_REG_CD LIKE '%CN%' OR PRDT_REG_CD LIKE '%FN%' OR PRDT_REG_CD LIKE '%EN%')
							AND ( BASK_PRDT_CD = PRDT_CD OR BASK_PRDT_CD = PRDT_REG_CD ) ), 'NOJJIM' )
						ELSE IFNULL( (SELECT PPB.BASK_IDX FROM PPM_PRDT_BASK PPB WHERE PPB.BASK_PRDT_CD = PRDT_CD AND PPB.BASK_USE_YN = 'Y' AND PPB.BASK_TYPE= 'K' AND PPB.USER_IDX = #{frontLoginIdx}), 'NOJJIM' )
					END
				) AS JJIM_IDX
			FROM (
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS MAIN_OPEN_DTM,
						IFNULL( DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS MAIN_OPEN_DTM_ORDR,
						SUBMAIN_OPEN_YN,
						DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS SUBMAIN_OPEN_DTM,
						IFNULL(DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS SUBMAIN_OPEN_DTM_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
						DEAL_DISC_PRIC,
						DEAL_REAL_PRIC,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_TIME_DEAL PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%VOD%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						DEAL_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS MAIN_OPEN_DTM,
						IFNULL( DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS MAIN_OPEN_DTM_ORDR,
						SUBMAIN_OPEN_YN,
						DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS SUBMAIN_OPEN_DTM,
						IFNULL(DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS SUBMAIN_OPEN_DTM_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
						DEAL_DISC_PRIC,
						DEAL_REAL_PRIC,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_TIME_DEAL PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%1:1%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						DEAL_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' ) OR PRDT_TYPE3 LIKE '%EN%'
				
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS MAIN_OPEN_DTM,
						IFNULL( DATE_FORMAT(MAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS MAIN_OPEN_DTM_ORDR,
						SUBMAIN_OPEN_YN,
						DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s') AS SUBMAIN_OPEN_DTM,
						IFNULL(DATE_FORMAT(SUBMAIN_OPEN_DTM, '%Y-%m-%d %H:%i:%s'), DATE_FORMAT('9999-12-31', '%Y-%m-%d %H:%i:%s') ) AS SUBMAIN_OPEN_DTM_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
						DEAL_DISC_PRIC,
						DEAL_REAL_PRIC,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_TIME_DEAL PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%LIVE%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						DEAL_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' )
			) LIST
			WHERE
				CATE_IDX IS NOT NULL
				AND SUBMAIN_OPEN_YN = 'Y'
				AND DEAL_DISC_PRIC IS NOT NULL
				AND DEAL_REAL_PRIC IS NOT NULL
				AND DATEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > -1
				AND TIMEDIFF( SUBMAIN_OPEN_DTM, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s') ) > '00:00:00'
				
		]]>
			<if test="searchVal not in {null, ''}">
				<if test='searchVal == "VOD" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%VOD%'
				]]>
				</if>
				<if test='searchVal == "1:1 코칭" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%1:1%'
				]]>
				</if>
				<if test='searchVal == "LIVE CLASS" '>
				<![CDATA[
				AND PRDT_TYPE LIKE '%LIVE%'
				]]>
				</if>
			</if>
		<![CDATA[
				
				
			ORDER BY MAIN_OPEN_DTM_ORDR, SUBMAIN_OPEN_DTM_ORDR, SYS_REG_DTM DESC
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
						) A JOIN (SELECT @rownumA:=0) rownumA
  ) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC
) C WHERE NUM_ASC BETWEEN 1 AND 99999999
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
		
</mapper>






