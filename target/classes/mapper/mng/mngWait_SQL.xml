<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="mngWait">

	<!-- 로그인 체크 -->
	<select id="selectMngWaitList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.*, REPLACE(CONVERT(C.NUM_DESC, CHAR),'.0','') AS NUM_DESC_ORDER FROM (
	SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
		SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
			
SELECT
			   	BUY_IDX,
			   	CATE_IDX,
				PRDT_CD,
				PRDT_TYPE,
					USER_IDX,
					DATE_FORMAT( TIME_DTM, '%Y-%m-%d') AS TIME_DTM,
					TIME_STR,
					(CASE TIME1 WHEN '' THEN '' ELSE LPAD(CONCAT(CONCAT( TRUNCATE( (TIME1+TIME2)/60, 0), ':'), LPAD(ROUND( (TIME1+TIME2)%60 ), 2, '0')),5,'0') END ) AS TIME_END,
					USER_NM,
					USER_NICK,
					USER_MAIL,
					
					EMAIL_YN,
					
					MASTER_NM,
					MASTER_ID,
					
					PRDT_NM,
					
					CONV_IDX,
					PRDT_IDX,
					
					WAIT_LINK,
					SANG_DAM_HWACK_JUNG_YN,
					DATE_FORMAT( BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM
				FROM (
					SELECT DISTINCT
						PUBH.BUY_IDX,
						PUBH.CATE_IDX,
						PUBH.USER_IDX,
						
						(SELECT USER_NICK FROM PPM_USER WHERE PPM_USER.USER_IDX = PUBH.USER_IDX ) AS USER_NICK,
						(SELECT USER_EMAIL FROM PPM_USER WHERE PPM_USER.USER_IDX = PUBH.USER_IDX ) AS USER_MAIL,
						
						(
							CASE PRDT_TYPE
								WHEN 'MAIL_IDX' THEN ( SELECT MAIL_END_DTM FROM PPM_PRDT_MAIL WHERE MAIL_IDX = PRDT.PRDT_IDX )
								ELSE IFNULL((SELECT TIME_DTM FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX),'')
							END
						) AS TIME_DTM,
						IFNULL(DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i'),'') AS TIME_STR,
						IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME1,
						IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 00:', (SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME2,
						( SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PUBH.USER_IDX ) AS USER_NM,
						PRDT_CD,
						(
							CASE PRDT_TYPE
								WHEN 'FACE_IDX' THEN '화상'
								WHEN 'LECT_IDX' THEN 'VOD'
								WHEN 'CHAT_IDX' THEN '채팅'
								WHEN 'MAIL_IDX' THEN '이메일'
								WHEN 'LIVE_IDX' THEN '라이브클래스'
							END
						) AS PRDT_TYPE,
						
						CASE PRDT_TYPE 
							WHEN 'MAIL_IDX' THEN ( CASE WHEN ( SELECT COUNT(0) FROM PPM_USER_BUY_MAIL WHERE BUY_IDX = PUBH.BUY_IDX AND SYS_REG_IDX = PUBH.USER_IDX ) < PRDT_CNT THEN '가능' ELSE '불가' END )
							ELSE '가능'
						END EMAIL_YN,
						
						PC.CODE_ID,
						
						(SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PC.USER_IDX) MASTER_NM,
						(SELECT USER_EMAIL FROM PPM_USER WHERE USER_IDX = PC.USER_IDX) MASTER_ID,
						
						PRDT_NM,
						
						'준비중' AS CONV_IDX,
						PRDT_IDX,
						IFNULL( BUY_IDX , '준비중' )  AS WAIT_LINK,
						SANG_DAM_HWACK_JUNG_YN,
						PUBH.BUY_COMP_DTM
					FROM 
						PPM_USER_BUY PUBH,
						PPM_CATE PC,
						PPM_USER PU,
						(
					        SELECT 'FACE_IDX' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD,(SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX )  AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX
					          UNION ALL
					            SELECT 'LECT_IDX' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM, ( SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD WHERE PPLD.LECT_IDX = PSLE.LECT_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPLD.DATA_IDX = PPVD.DATA_IDX AND PPVD.DATA_USE_YN = 'Y' ) AS PRDT_CNT FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX
					          UNION ALL
					            SELECT 'CHAT_IDX' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD =  CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX
					          UNION ALL
					            SELECT 'MAIL_IDX' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM, PPM.MAIL_CNT AS PRDT_CNT FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX
					          UNION ALL
					            SELECT 'LIVE_IDX' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX
                      ) PRDT
					WHERE
						PUBH.CATE_IDX = PC.CATE_IDX
						AND PC.USER_IDX = PU.USER_IDX
						AND PRDT.CATE_IDX = PC.CATE_IDX
						AND PUBH.BUY_PRDT_CD = PRDT.PRDT_CD
						AND PUBH.BUY_REFU_YN = 'N'
						AND PUBH.BUY_STAT = '결제완료'
						AND PUBH.BUY_NO IS NOT NULL
			]]>
				<if test='mngLoginType not in {"A"}'>
					<![CDATA[
						AND PC.USER_IDX = #{mngLoginIdx }
					]]>
				</if>
			<![CDATA[
						
				) MAIN
				WHERE
					-- 대기 상담
				--	( DATE_FORMAT(TIME_DTM, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d') OR TIME_DTM = '' OR PRDT_TYPE = '이메일' )
					( DATE_FORMAT(CONCAT(TIME_DTM,' ', (CASE TIME1 WHEN '' THEN '' ELSE LPAD(CONCAT(CONCAT( TRUNCATE( (TIME1+TIME2)/60, 0), ':'), LPAD(ROUND( (TIME1+TIME2)%60 ), 2, '0')),5,'0') END ), ':00'), '%Y-%m-%d %H:%i:%S') >= DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S') OR TIME_DTM = '' OR (PRDT_TYPE = '이메일' AND EMAIL_YN = '가능' ) )
				--	AND EMAIL_YN = '가능'
				
					AND PRDT_TYPE != 'VOD'
		]]>
			<if test="prdtType not in {null, ''}">
				<![CDATA[
					AND PRDT_TYPE = #{prdtType}
				]]>
			</if>
			<if test="parentCodeId not in {null, ''}">
				<![CDATA[
					AND CODE_ID LIKE '%${parentCodeId}%'
				]]>
			</if>

			<if test="codeId not in {null, ''}">
				<![CDATA[
					AND CODE_ID = #{codeId}
				]]>
			</if>
			
			<if test="masterId not in {null, ''}">
				<![CDATA[
					AND MASTER_ID LIKE '%${masterId}%'
				]]>
			</if>

			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( MASTER_NM LIKE '%${masterNm}%' OR USER_NM LIKE '%${masterNm}%' )
				]]>
			</if>

			<if test="timeDtmSrt not in {null, ''} and timeDtmEnd not in {null, ''}">
				<![CDATA[
					AND ( DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) BETWEEN #{timeDtmSrt} AND #{timeDtmEnd} OR DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = '0000-00-00' )
				]]>
			</if>

			<if test="timeDtmSrt in {null, ''} and timeDtmEnd in {null, ''}">
				<![CDATA[
					-- AND ( DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = DATE_FORMAT( NOW(), '%Y-%m-%d' ) OR DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = '0000-00-00' )
				]]>
			</if>
		<![CDATA[ 

				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
		) A JOIN (SELECT @rownumA:=0) rownumA ORDER BY TIME_DTM, BUY_IDX
	) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<!-- 로그인 체크 -->
	<select id="selectMngWaitListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT
				COUNT(0) AS CNT
			FROM (
				SELECT
				   	BUY_IDX,
				   	CATE_IDX,
					PRDT_CD,
					PRDT_TYPE,
					USER_IDX,
					DATE_FORMAT( TIME_DTM, '%Y-%m-%d') AS TIME_DTM,
					TIME_STR,
					(CASE TIME1 WHEN '' THEN '' ELSE LPAD(CONCAT(CONCAT( TRUNCATE( (TIME1+TIME2)/60, 0), ':'), LPAD(ROUND( (TIME1+TIME2)%60 ), 2, '0')),5,'0') END ) AS TIME_END,
					USER_NM,
					USER_NICK,
					USER_MAIL,
					
					EMAIL_YN,
					
					MASTER_NM,
					MASTER_ID,
					
					PRDT_NM,
					
					CONV_IDX,
					PRDT_IDX,
					
					WAIT_LINK,
					SANG_DAM_HWACK_JUNG_YN
				FROM (
					SELECT DISTINCT
						PUBH.BUY_IDX,
						PUBH.CATE_IDX,
						PUBH.USER_IDX,
						
						(SELECT USER_NICK FROM PPM_USER WHERE PPM_USER.USER_IDX = PUBH.USER_IDX ) AS USER_NICK,
						(SELECT USER_EMAIL FROM PPM_USER WHERE PPM_USER.USER_IDX = PUBH.USER_IDX ) AS USER_MAIL,
						
						(
							CASE PRDT_TYPE
								WHEN 'MAIL_IDX' THEN ( SELECT MAIL_END_DTM FROM PPM_PRDT_MAIL WHERE MAIL_IDX = PRDT.PRDT_IDX )
								ELSE IFNULL((SELECT TIME_DTM FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX),'')
							END
						) AS TIME_DTM,
						IFNULL(DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i'),'') AS TIME_STR,
						IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME1,
						IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 00:', (SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE TIME_IDX = PUBH.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME2,
						( SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PUBH.USER_IDX ) AS USER_NM,
						PRDT_CD,
						(
							CASE PRDT_TYPE
								WHEN 'FACE_IDX' THEN '화상'
								WHEN 'LECT_IDX' THEN 'VOD'
								WHEN 'CHAT_IDX' THEN '채팅'
								WHEN 'MAIL_IDX' THEN '이메일'
								WHEN 'LIVE_IDX' THEN '라이브클래스'
							END
						) AS PRDT_TYPE,
						
						CASE PRDT_TYPE 
							WHEN 'MAIL_IDX' THEN ( CASE WHEN ( SELECT COUNT(0) FROM PPM_USER_BUY_MAIL WHERE BUY_IDX = PUBH.BUY_IDX AND SYS_REG_IDX = PUBH.USER_IDX ) < PRDT_CNT THEN '가능' ELSE '불가' END )
							ELSE '가능'
						END EMAIL_YN,
						
						PC.CODE_ID,
						
						(SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PC.USER_IDX) MASTER_NM,
						(SELECT USER_EMAIL FROM PPM_USER WHERE USER_IDX = PC.USER_IDX) MASTER_ID,
						
						PRDT_NM,
						
						'준비중' AS CONV_IDX,
						PRDT_IDX,
						IFNULL( BUY_IDX , '준비중' )  AS WAIT_LINK,
						SANG_DAM_HWACK_JUNG_YN
					FROM 
						PPM_USER_BUY PUBH,
						PPM_CATE PC,
						PPM_USER PU,
						(
					        SELECT 'FACE_IDX' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD,(SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX )  AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX
					          UNION ALL
					            SELECT 'LECT_IDX' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM, ( SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD WHERE PPLD.LECT_IDX = PSLE.LECT_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPLD.DATA_IDX = PPVD.DATA_IDX AND PPVD.DATA_USE_YN = 'Y' ) AS PRDT_CNT FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX
					          UNION ALL
					            SELECT 'CHAT_IDX' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD =  CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX
					          UNION ALL
					            SELECT 'MAIL_IDX' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM, PPM.MAIL_CNT AS PRDT_CNT FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX
					          UNION ALL
					            SELECT 'LIVE_IDX' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM, 1 AS PRDT_CNT FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX
                      ) PRDT
					WHERE
						PUBH.CATE_IDX = PC.CATE_IDX
						AND PC.USER_IDX = PU.USER_IDX
						AND PRDT.CATE_IDX = PC.CATE_IDX
						AND PUBH.BUY_PRDT_CD = PRDT.PRDT_CD
						AND PUBH.BUY_REFU_YN = 'N'
						AND PUBH.BUY_STAT = '결제완료'
						AND PUBH.BUY_NO IS NOT NULL
			]]>
				<if test='mngLoginType not in {"A"}'>
					<![CDATA[
						AND PC.USER_IDX = #{mngLoginIdx }
					]]>
				</if>
			<![CDATA[
						
				) MAIN
				WHERE
					-- 대기 상담
				--	( DATE_FORMAT(TIME_DTM, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d') OR TIME_DTM = '' OR PRDT_TYPE = '이메일' )
					( DATE_FORMAT(CONCAT(TIME_DTM,' ', (CASE TIME1 WHEN '' THEN '' ELSE LPAD(CONCAT(CONCAT( TRUNCATE( (TIME1+TIME2)/60, 0), ':'), LPAD(ROUND( (TIME1+TIME2)%60 ), 2, '0')),5,'0') END ), ':00'), '%Y-%m-%d %H:%i:%S') >= DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S') OR TIME_DTM = '' OR (PRDT_TYPE = '이메일' AND EMAIL_YN = '가능' ) )
				--	AND EMAIL_YN = '가능'
				
					AND PRDT_TYPE != 'VOD'
		]]>
			<if test="prdtType not in {null, ''}">
				<![CDATA[
					AND PRDT_TYPE = #{prdtType}
				]]>
			</if>
			<if test="parentCodeId not in {null, ''}">
				<![CDATA[
					AND CODE_ID LIKE '%${parentCodeId}%'
				]]>
			</if>

			<if test="codeId not in {null, ''}">
				<![CDATA[
					AND CODE_ID = #{codeId}
				]]>
			</if>
			
			<if test="masterId not in {null, ''}">
				<![CDATA[
					AND MASTER_ID LIKE '%${masterId}%'
				]]>
			</if>

			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( MASTER_NM LIKE '%${masterNm}%' OR USER_NM LIKE '%${masterNm}%' )
				]]>
			</if>

			<if test="timeDtmSrt not in {null, ''} and timeDtmEnd not in {null, ''}">
				<![CDATA[
					AND ( DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) BETWEEN #{timeDtmSrt} AND #{timeDtmEnd} OR DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = '0000-00-00' )
				]]>
			</if>

			<if test="timeDtmSrt in {null, ''} and timeDtmEnd in {null, ''}">
				<![CDATA[
					-- AND ( DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = DATE_FORMAT( NOW(), '%Y-%m-%d' ) OR DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = '0000-00-00' )
				]]>
			</if>
		<![CDATA[ 
				  ) CNT  
		]]>
	</select>
	
	<select id="selectMngQuesList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
SELECT C.*, REPLACE(CONVERT(C.NUM_DESC, CHAR),'.0','') AS NUM_DESC_ORDER FROM (
  SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
    SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
			    
			    SELECT
			    	PPQD.DATA_IDX,
				 	PPQ.QUES_IDX,
				 	PPQ.QUES_CNTN,
				 	PPQD.DATA_CNTN
				FROM 
					PPM_PRDT_QUES PPQ,
					PPM_PRDT_QUES_DATA PPQD
				WHERE
					QUES_USE_YN = 'Y'
					AND PPQ.QUES_IDX = PPQD.QUES_IDX
					AND PPQD.BUY_IDX = #{buyIdx}
		]]>
			<if test="prdtType not in {null, ''}">
				<if test="prdtType == '채팅' ">
					<![CDATA[
						AND CHAT_IDX = #{prdtIdx}
					]]>
				</if>
				<if test="prdtType == '화상' ">
					<![CDATA[
						AND FACE_IDX = #{prdtIdx}
					]]>
				</if>
				<if test="prdtType == '라이브클래스' ">
					<![CDATA[
						AND LIVE_IDX = #{prdtIdx}
					]]>
				</if>
			</if>
		<![CDATA[ 
					
	) A JOIN (SELECT @rownumA:=0) rownumA
  ) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY DATA_IDX
) C WHERE NUM_ASC BETWEEN #{startRow } AND '9999'
		]]>
	</select>
	
	
	
	
	<select id="selectMngBuyConsList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		SELECT
			BUY_IDX,
			
			TIME_DTM,
			TIME_STR,
			(CASE TIME1 WHEN '' THEN '' ELSE LPAD(CONCAT(CONCAT( TRUNCATE( (TIME1+TIME2)/60, 0), ':'), LPAD(ROUND( (TIME1+TIME2)%60 ), 2, '0')),5,'0') END ) AS TIME_END,
			DATE_FORMAT( TIME_STR_DTM, '%Y-%m-%d') AS TIME_STR_DTM,
			DATE_FORMAT( TIME_END_DTM, '%Y-%m-%d') AS TIME_END_DTM,
			PRDT_TYPE,
			
			MASTER_NM,
			USER_NM,
			HIST_CNTN,
			HIST_UUID,
			SYS_REG_DTM
		FROM (
				SELECT
				   	PUB.BUY_IDX,
					IFNULL((SELECT TIME_DTM FROM PPM_PRDT_TIME WHERE TIME_IDX = PUB.TIME_IDX),'') AS TIME_DTM,
					IFNULL(DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUB.TIME_IDX)), '%H:%i'),'') AS TIME_STR,
					IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 ', (SELECT TIME_STR FROM PPM_PRDT_TIME WHERE TIME_IDX = PUB.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME1,
					IFNULL(ROUND(TIME_TO_SEC( DATE_FORMAT(CONCAT('0000-00-00 00:', (SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE TIME_IDX = PUB.TIME_IDX)), '%H:%i') )/60 ),'') AS TIME2,
					
					(
						CASE PRDT_TYPE
							WHEN 'MAIL_IDX' THEN ( SELECT MAIL_STR_DTM FROM PPM_PRDT_MAIL WHERE MAIL_IDX = PRDT.PRDT_IDX )
							ELSE ''
						END
					) AS TIME_STR_DTM,
				   	
					(
						CASE PRDT_TYPE
							WHEN 'MAIL_IDX' THEN ( SELECT MAIL_END_DTM FROM PPM_PRDT_MAIL WHERE MAIL_IDX = PRDT.PRDT_IDX )
							ELSE ''
						END
					) AS TIME_END_DTM,
					PRDT_TYPE,
					
			    	IFNULL(( SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PUBC.MAST_USER_IDX ), "") AS MASTER_NM,
			    	IFNULL(( SELECT USER_NM FROM PPM_USER WHERE USER_IDX = PUBC.USER_IDX ), "") AS USER_NM,
			    	PUBC.HIST_CNTN,
			    	PUBC.HIST_UUID,
			    	DATE_FORMAT( PUBC.SYS_REG_DTM, '%Y-%m-%d %H:%i:%S') AS SYS_REG_DTM
				FROM 
					PPM_USER_BUY PUB,
					PPM_USER_BUY_CONS PUBC LEFT JOIN
					(
						SELECT 'CHAT_IDX' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM
						FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX
					UNION ALL
						SELECT 'FACE_IDX' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM
						FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX
					UNION ALL
						SELECT 'LECT_IDX' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM
						FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX
					UNION ALL
						SELECT 'LIVE_IDX' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM
						FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX
					UNION ALL
						SELECT 'MAIL_IDX' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, (SELECT CONCAT(PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM
						FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX
					) PRDT
						ON PUBC.CATE_IDX = PRDT.CATE_IDX
				WHERE
					PUBC.BUY_IDX = PUB.BUY_IDX
					AND PRDT_CD = #{prdtCd}
					AND PUB.USER_IDX = #{userIdx}
				ORDER BY PUBC.SYS_REG_DTM
		) MAIN 
		
		]]>
	</select>
	
	<select id="selectMngBuyVodList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
SELECT C.*, REPLACE(CONVERT(C.NUM_DESC, CHAR),'.0','') AS NUM_DESC_ORDER FROM (
  SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
    SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
		SELECT
			PPV.VOD_IDX,
		    PU.USER_NM,
		    PPLE.LECT_NM,
		    PPV.VOD_NM,
		    PPVD.DATA_TITL,
		    PPVD.DATA_CD,
	    	( SELECT COUNT(0) FROM PPM_PRDT_VOD_DATA WHERE VOD_IDX = PPV.VOD_IDX ) AS VOD_TOTAL
		FROM 
			PPM_USER_BUY_PROG PUBP,
			PPM_USER_BUY PUB,
			PPM_PRDT_LECT PPLE,
			PPM_PRDT_LECT_DATA PPLD,
			PPM_PRDT_VOD PPV,
			PPM_PRDT_VOD_DATA PPVD,
			PPM_USER PU,
			PPM_CATE PC
		WHERE
			PUBP.BUY_IDX = PUB.BUY_IDX
			AND PUBP.DATA_IDX = PPVD.DATA_IDX
			AND PUB.CATE_IDX = PC.CATE_IDX
			AND PUB.BUY_PRDT_CD = PPLE.LECT_CD
			AND PPLE.LECT_IDX = PPLD.LECT_IDX
			AND PPLD.VOD_IDX = PPVD.VOD_IDX
			AND PPLD.VOD_IDX = PPV.VOD_IDX
			AND PC.USER_IDX = PU.USER_IDX
			
			AND PUB.BUY_IDX = #{buyIdx}
			AND PUB.BUY_PRDT_CD = #{prdtCd}
					
	) A JOIN (SELECT @rownumA:=0) rownumA
  ) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY VOD_IDX DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND '9999'
		]]>
	</select>
	
	
	
	
	
	<select id="selectPaySmsList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT
				PUB.BUY_IDX,
				PU_M.USER_NM AS M_USER_NM,
				PU_M.USER_PHONE AS M_USER_PHONE,
				PU_U.USER_NM,
				PU_U.USER_PHONE,
				
				PUB.BUY_PRDT_CD,
				(
					CASE
						WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
						WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상코칭'
						WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅코칭'
						WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일코칭'
					END
				) AS PRDT_TYPE,
				(
					CASE
						WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN DATE_FORMAT( ( SELECT DATE_ADD(DATE_FORMAT( PUB.BUY_COMP_DTM, '%Y-%m-%d' ), INTERVAL MAIL_CNT DAY) FROM PPM_PRDT_MAIL WHERE MAIL_CD = PUB.BUY_PRDT_CD ), '%m월 %d일' )
						ELSE ''
					END
				) AS PRDT_TERM,
				PUB.TIME_IDX,
				PPT.TIME_DTM,
				DATE_FORMAT(PPT.TIME_DTM, '%m월 %d일') TIME_DTM_NM,
				PPT.TIME_STR
			FROM 
				PPM_USER_BUY PUB
					LEFT OUTER JOIN PPM_PRDT_TIME PPT ON PUB.TIME_IDX = PPT.TIME_IDX
					LEFT JOIN PPM_CATE PC ON PUB.CATE_IDX = PC.CATE_IDX	
					LEFT JOIN PPM_USER PU_M ON PC.USER_IDX = PU_M.USER_IDX				
					LEFT JOIN PPM_USER PU_U ON PUB.USER_IDX = PU_U.USER_IDX					
			WHERE 
			]]>
		<if test='buyNo not in {null, ""}'>
		<![CDATA[
				BUY_NO = #{buyNo} 
		]]>
		</if>
		<if test='buyNo in {null, ""}'>
		<![CDATA[
				PUB.BUY_IDX = #{buyIdx} 
		]]>
		</if>
	</select>
	
	<select id="selectHwackjungDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				BUY_IDX, 
				BUY_PRDT_CD, 
				SANG_DAM_HWACK_JUNG_YN 
					FROM 
						PPM_USER_BUY 
						
						WHERE 
							BUY_IDX = #{buyIdx}
				
		]]>
	</select>

	<update id="updateHwackjungYn" parameterType="hashmap" >
		<![CDATA[
			UPDATE 
				PPM_USER_BUY 
					SET
						SANG_DAM_HWACK_JUNG_YN = 'Y',
						SANG_DAM_HWACK_JUNG_DTM = DATE_FORMAT( NOW() , '%Y-%m-%d %H:%i:%S')
 						
						WHERE
							BUY_IDX = #{buyIdx}
		]]>
	</update>
	
	<insert id="insertChatEnd" parameterType="hashmap">
		<![CDATA[
			INSERT INTO PPM_CHAT
				(USER_TYPE, USER_IDX, CHAT_ROOM, CHAT_TYPE, CHAT_MSG, CHAT_DT)
				
				VALUES
				(
					'M', 
					#{mngLoginIdx},
					#{buyIdx}, 
					'E',
					'마스터님께서 나가셨습니다.',
					DATE_FORMAT(NOW(),'%Y%m%d%H%i%S')
				)
	
		]]>
	</insert>
	
</mapper>
