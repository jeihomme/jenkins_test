<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="mngMdpick">

	<!-- 로그인 체크 -->
	<select id="selectMngMdpickList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.*, REPLACE(CONVERT(C.NUM_DESC, CHAR),'.0','') AS NUM_DESC_ORDER FROM (
  SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
    SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
			SELECT
				*
			FROM (
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%VOD%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%1:1%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' ) OR PRDT_TYPE3 LIKE '%EN%'
				
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%LIVE%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' )
			) LIST
			WHERE
				CATE_IDX IS NOT NULL
				
		]]>
			<if test="searchVal not in {null, ''}">
				<if test='searchVal == "VOD" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%VOD%'
				]]>
				</if>
				<if test='searchVal == "1:1 코칭" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%1:1%'
				]]>
				</if>
				<if test='searchVal == "LIVE CLASS" '>
				<![CDATA[
				AND PRDT_TYPE LIKE '%LIVE%'
				]]>
				</if>
			</if>
		<![CDATA[
				
				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
						) A JOIN (SELECT @rownumA:=0) rownumA
  ) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC DESC
) C WHERE NUM_ASC BETWEEN 1 AND 99999999
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<!-- 로그인 체크 -->
	<select id="selectMngMdpickListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT
				COUNT(0)
			FROM (
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%VOD%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%1:1%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' ) OR PRDT_TYPE3 LIKE '%EN%'
				
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%LIVE%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' )
			) LIST
			WHERE
				CATE_IDX IS NOT NULL
				
		]]>
			<if test="searchVal not in {null, ''}">
				<if test='searchVal == "VOD" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%VOD%'
				]]>
				</if>
				<if test='searchVal == "1:1 코칭" '>
				<![CDATA[
 				AND PRDT_TYPE LIKE '%1:1%'
				]]>
				</if>
				<if test='searchVal == "LIVE CLASS" '>
				<![CDATA[
				AND PRDT_TYPE LIKE '%LIVE%'
				]]>
				</if>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<select id="selectMngMdpickDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				*
			FROM (
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%VOD%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%1:1%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' ) OR PRDT_TYPE3 LIKE '%EN%'
				
				UNION ALL
				
				SELECT
					*
				FROM (
					SELECT DISTINCT
						MAIN_OPEN_YN,
						MAIN_OPEN_ORDR,
						SUBMAIN_OPEN_YN,
						SUBMAIN_OPEN_ORDR,
						PSCV.PRDT_CD AS PRDT_REG_CD,
						S_CODE.CODE_NM AS S_CODE_NM,
						DATE_FORMAT(PSCV.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					
						PPV.*,
						PPV.PRDT_CD AS SALE_PRDT_CD,
						PC.CATE_ORDR,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC_CD FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC_CD,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT PRDT_DISC FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_DISC,
						(
							CASE
								WHEN PPV.PRDT_CD LIKE '%VL%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								WHEN PPV.PRDT_CD LIKE '%LN%' THEN ( SELECT PRDT_PRIC_REAL FROM PPM_SALE_CD_VIEW WHERE PRDT_CD = PPV.PRDT_CD )
								ELSE ( SELECT FORMAT( PRDT_PRIC_REAL, 0 ) FROM PPM_SALE_CD_VIEW WHERE CATE_IDX = REPLACE(PPV.PRDT_CD, 'COACHING', '') AND ( PRDT_CD NOT LIKE '%VL%' OR PRDT_CD NOT LIKE '%LN%' ) ORDER BY PRDT_PRIC_REAL LIMIT 1 )
							END
						) AS PRDT_PRIC_REAL,
						CONVERT ( GROUP_CONCAT(
					    	(SELECT COUNT(0) FROM PPM_PRDT_TIME
					    		WHERE
										(
											CHAT_IDX = PSCV.PRDT_IDX
											OR LIVE_IDX = PSCV.PRDT_IDX
											OR FACE_IDX = PSCV.PRDT_IDX
										)
										AND DATEDIFF(TIME_DTM, NOW()) >= 0
										AND TIME_USE_YN = 'Y'
										AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
									ORDER BY TIME_DTM, TIME_STR
					    	)
					    ORDER BY
						PSCV.PRDT_CD ASC SEPARATOR ',' ), CHAR ) AS TIME_CNT
					
					FROM
						PPM_PRDT_VIEW PPV
							LEFT JOIN PPM_CATE PC ON PPV.CATE_IDX = PC.CATE_IDX
							LEFT JOIN PPM_SALE_CD_VIEW PSCV
								ON PSCV.CATE_IDX = PPV.CATE_IDX
								AND PPV.PRDT_CD = ( CASE WHEN PSCV.PRDT_CD LIKE '%VL%' THEN PSCV.PRDT_CD WHEN PSCV.PRDT_CD LIKE '%LN%' THEN PSCV.PRDT_CD ELSE CONCAT('COACHING',PSCV.CATE_IDX) END )
							LEFT JOIN PPM_CODE S_CODE ON S_CODE.CODE_ID = PSCV.CHAT_STAT_CD
							
							LEFT OUTER JOIN PPM_MDPICK PM ON PM.PRDT_CD = PSCV.PRDT_CD
					WHERE
						PC.CATE_IDX IS NOT NULL
						AND PC.CATE_USE_YN = 'Y'
						AND PC.CATE_READ_YN = 'Y'
						AND PSCV.SYS_REG_DTM IS NOT NULL
						AND PRDT_TYPE LIKE '%LIVE%'
				
					GROUP BY
						CATE_IDX
					ORDER BY
						MD_IDX DESC
				) MAIN
				WHERE
					PRDT_PRIC IS NOT NULL
					AND TIME_CNT NOT IN ( '0', '0,0', '0,0,0', '0,0,0,0', '0,0,0,0,0' )
			) LIST
			WHERE
				CATE_IDX IS NOT NULL
				AND PRDT_REG_CD = #{prdtRegCd}
		]]>
	</select>
	
	<update id="insertMdpickMainOpenYnData" parameterType="hashmap">
		<![CDATA[
		
		INSERT INTO 
			PPM_MDPICK (
				PRDT_CD,
				MAIN_OPEN_YN,
				MAIN_OPEN_ORDR,
				SUBMAIN_OPEN_YN,
				SUBMAIN_OPEN_ORDR,
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX,
				SYS_MOD_DTM
			) VALUES (
				#{prdtCd},
				#{mainOpenYn},
				#{mainOpenOrdr},
				#{submainOpenYn},
				#{submainOpenOrdr},
				
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
			) ON DUPLICATE KEY UPDATE
				MAIN_OPEN_YN=#{mainOpenYn}, 
				
				SYS_MOD_IDX=#{mngLoginIdx}, 
				SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')

		]]>
	</update>
	
	<update id="insertMdpickMSubOpenYnData" parameterType="hashmap">
		<![CDATA[
		
		INSERT INTO 
			PPM_MDPICK (
				PRDT_CD,
				MAIN_OPEN_YN,
				MAIN_OPEN_ORDR,
				SUBMAIN_OPEN_YN,
				SUBMAIN_OPEN_ORDR,
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX,
				SYS_MOD_DTM
			) VALUES (
				#{prdtCd},
				#{mainOpenYn},
				#{mainOpenOrdr},
				#{submainOpenYn},
				#{submainOpenOrdr},
				
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
			) ON DUPLICATE KEY UPDATE
				SUBMAIN_OPEN_YN=#{submainOpenYn}, 
				
				SYS_MOD_IDX=#{mngLoginIdx}, 
				SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')

		]]>
	</update>
	
	<update id="insertMdpickMOrdrData" parameterType="hashmap">
		<![CDATA[
		
		INSERT INTO 
			PPM_MDPICK (
				PRDT_CD,
				MAIN_OPEN_YN,
				MAIN_OPEN_ORDR,
				SUBMAIN_OPEN_YN,
				SUBMAIN_OPEN_ORDR,
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX,
				SYS_MOD_DTM
			) VALUES (
				#{prdtCd},
				#{mainOpenYn},
				#{mainOpenOrdr},
				#{submainOpenYn},
				#{submainOpenOrdr},
				
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
			) ON DUPLICATE KEY UPDATE
				MAIN_OPEN_ORDR=#{mainOpenOrdr}, 
				SUBMAIN_OPEN_ORDR=#{submainOpenOrdr},
				
				SYS_MOD_IDX=#{mngLoginIdx}, 
				SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')

		]]>
	</update>
	
	<update id="insertMdpickData" parameterType="hashmap">
		<![CDATA[
		
		INSERT INTO 
			PPM_MDPICK (
				PRDT_CD,
				MAIN_OPEN_YN,
				MAIN_OPEN_ORDR,
				SUBMAIN_OPEN_YN,
				SUBMAIN_OPEN_ORDR,
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX,
				SYS_MOD_DTM
			) VALUES (
				#{prdtCd},
				#{mainOpenYn},
				#{mainOpenOrdr},
				#{submainOpenYn},
				#{submainOpenOrdr},
				
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
				#{mngLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
			) ON DUPLICATE KEY UPDATE
				MAIN_OPEN_YN=#{mainOpenYn}, 
				MAIN_OPEN_ORDR=#{mainOpenOrdr}, 
				SUBMAIN_OPEN_ORDR=#{submainOpenOrdr},
				SUBMAIN_OPEN_YN=#{submainOpenYn}, 
				
				SYS_MOD_IDX=#{mngLoginIdx}, 
				SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')

		]]>
	</update>
	
</mapper>
