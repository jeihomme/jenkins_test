<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="frontMypage">

<!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 --><!-- 	결제내역 -->
	<select id="selectFrontPayList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.* FROM (
	SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
		SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
		 SELECT
				(
					CASE
						WHEN BUY_PRDT_CD LIKE '%VL%' THEN PRDT_USE_DTM
						WHEN BUY_PRDT_CD LIKE '%EN%' THEN PRDT_USE_DTM
						ELSE	(
						 			SELECT
										CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d,%H:%i' ) ,', ',PPT.TIME_RUN, '분')
									FROM
										PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
								)
					END
				) AS PRDT_TIME,
				
				CATE_IDX,	
					
				BUY_COMP_DTM,
				DATEDIFF(
					DATE_FORMAT(
						DATE_ADD(
							DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
							INTERVAL (
								SELECT TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
							) MINUTE )
					, '%Y-%m-%d %H:%i:%S' ),
					(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
					)
				) AS BUY_REFU_DATE_DIFF,
				CONVERT( TIMEDIFF(
					DATE_FORMAT(
						DATE_ADD(
							DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
							INTERVAL (
								SELECT TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
							) MINUTE )
					, '%Y-%m-%d %H:%i:%S' ),
					(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
					)
				), CHAR) AS BUY_REFU_TIME_DIFF,
				(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
				) AS BUY_END_TIME,
				
				BUY_ORDER_NUMBER, BUY_NO, BUY_IDX, BUY_NO_CNT, PRDT_TYPE, BUY_PRDT_CD, BUY_PRDT_CD AS PRDT_CD,
				PRDT_NM, PRDT_NM1, PRDT_NM2, MASTER_NM, PARENT_CODE_NM, CODE_NM, USER_NM, USER_PHONE,
				BUY_TYPE, BUY_PRIC, REAL_PAY_PRIC, REAL_DISC_PRIC, REAL_CNT, 
				COUP_DISC, COUP_DISC_NM, CASH_RECEIPT, BUY_STAT, PRDT_UUID, BUY_CARD_NO,
				PRDT_CNT, BUY_ACCO_NO, BUY_COMP_YN, BUY_CD, INFO_PRDT_TITL1, INFO_PRDT_TITL2, INFO_TUMB_UUID, INFO_TUMB_UUID_NM, REFUND_TAKE
				
			FROM (
			
				SELECT
					PUB.TIME_IDX,
					PRDT.CATE_IDX,
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM,
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d %H:$i:%S') AS BUY_COMP_DTM_ALL,
					PUB.BUY_NO,
					PUB.BUY_IDX,
					PUB.BUY_ORDER_NUMBER,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND (BUY_REFU_YN = 'N' || BUY_REFU_YN = 'R') ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.BUY_PRDT_CD,
					PRDT_TIME,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN CONCAT(  DATE_FORMAT( PUB.BUY_COMP_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT( DATE_ADD( PUB.BUY_COMP_DTM , INTERVAL PRDT.PRDT_TIME DAY) , '%Y-%m-%d' ), ', ', PRDT.PRDT_TIME, '일' ) 
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN CONCAT(   CONCAT( DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT( DATE_ADD( PUB.BUY_COMP_DTM, INTERVAL SUBSTRING_INDEX( PRDT.PRDT_TIME, ',' , 1 ) DAY ), '%Y-%m-%d' ) ,', ', SUBSTRING_INDEX( SUBSTRING_INDEX( PRDT.PRDT_TIME, ',', 2),',' , -1 )), '회' ) 
							ELSE ''
						END 
					) AS PRDT_USE_DTM,
					
					PRDT.PRDT_NM1, PRDT.PRDT_NM2, CONCAT( PRDT.PRDT_NM1, ' ',PRDT.PRDT_NM2 )  AS PRDT_NM, PU.USER_NM AS MASTER_NM,
					P_CODE.CODE_NM AS PARENT_CODE_NM, M_CODE.CODE_NM AS CODE_NM, PU_U.USER_NM, PU_U.USER_PHONE, PUB.BUY_TYPE, PUB.BUY_PRIC,
					
					CAST( SUM(PUB.REAL_PAY_PRIC) AS CHAR ) REAL_PAY_PRIC,
					CAST( SUM(PUB.REAL_DISC_PRIC)  AS CHAR ) REAL_DISC_PRIC,
					COUNT(0) REAL_CNT,
					
					P_COUP.COUP_DISC,
					PUB_CODE.CODE_NM AS COUP_DISC_NM,
					CASH_RECEIPT,
					PUB.COUP_IDX,
					BUY_STAT,
					IF( PUB.BUY_CARD_NO ='' OR PUB.BUY_CARD_NO IS NULL , 'NOCARD', PUB.BUY_CARD_NO ) BUY_CARD_NO,
					
					(SELECT PIP.INFO_TUMB_UUID 
						FROM PPM_INFO_PRDT PIP 
						WHERE 
							PIP.CATE_IDX = PRDT.CATE_IDX
							AND 
							PIP.PRDT_CD = (
								CASE 
									WHEN INSTR(PIP.PRDT_CD,'COACHING') = 1 THEN CONCAT('COACHING',PRDT.CATE_IDX) 
									ELSE PIP.PRDT_CD
								END	
							)
							AND PIP.INFO_ORDE = '0'
							AND PIP.INFO_USE_YN = 'Y'
						
							ORDER BY PIP.INFO_IDX DESC 
							LIMIT 1
						
					) AS PRDT_UUID,
					
					(
						CASE PRDT_TYPE
							WHEN '1:1화상상담' THEN ''
							WHEN 'VOD' THEN 
												CONCAT(CONVERT((
													SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD
													WHERE PPLD.LECT_IDX = PRDT.PRDT_IDX AND PPLD.VOD_IDX = PPVD.VOD_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y' 
												), CHAR), ' 개')
							WHEN '1:1채팅상담' THEN ''
							WHEN '1:1이메일상담' THEN CONCAT(( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ), ' 건')
							WHEN 'LIVE CLASS' THEN ''
						END
					) AS PRDT_CNT,
					BUY_ACCO_NO,
					BUY_COMP_YN,
					BUY_CD,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL1,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL2,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_TUMB_UUID,
					'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
					
					CASE PRDT.PRDT_TYPE
						WHEN 'VOD' THEN 
							CASE 
								WHEN (SELECT COUNT(0) FROM PPM_USER_BUY_PROG PUBP WHERE PUBP.BUY_IDX = PUB.BUY_IDX) < 2  
										AND IFNULL((SELECT DATEDIFF( PUBP.SYS_REG_DTM, NOW() )   FROM PPM_USER_BUY_PROG PUBP WHERE PUBP.BUY_IDX = PUB.BUY_IDX ORDER BY SYS_REG_DTM ASC LIMIT 1 ),'0') > -3
								THEN 'Y'
								ELSE 'N'
								END
						WHEN '1:1이메일상담' THEN (SELECT IF( COUNT(0) > 0, 'N', 'Y'  ) FROM PPM_USER_BUY_MAIL PUBM WHERE PUBM.BUY_IDX = PUB.BUY_IDX )
						ELSE NULL						
					END REFUND_TAKE
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX 
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID, 
					PPM_CATE PC,
					PPM_USER PU,
					PPM_USER PU_U,
					PPM_CODE P_CODE,
					PPM_CODE M_CODE,
					(
				      SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, 'FN' AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, 'CN' AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( PPM.MAIL_DTM_CNT, ',' , PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, 'LN' AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
				    ) PRDT
				WHERE
					(PUB.BUY_STAT NOT LIKE '%취소완료%' && PUB.BUY_STAT NOT LIKE '%환불완료%' && PUB.BUY_STAT IS NOT NULL)
				--	PUB.BUY_REFU_YN = 'N'
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PUB.CATE_IDX = PC.CATE_IDX
					AND PC.USER_IDX = PU.USER_IDX
					AND PU_U.USER_IDX = PUB.USER_IDX
					AND P_CODE.CODE_ID = SUBSTR(PC.CODE_ID, 1 , 5)
					AND M_CODE.CODE_ID = PC.CODE_ID
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
				--	AND PPT.TIME_IDX = PUB.TIME_IDX
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
					GROUP BY BUY_NO
					
			) MAIN
			WHERE
				BUY_NO_CNT > 0 
				 
					 
		]]>
			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( MASTER_NM LIKE '%${masterNm}%' OR PRDT_NM LIKE '%${masterNm}%' )
				]]>
			</if>
			<if test="startDate not in {null, ''} and endDate not in {null, ''}">
				<![CDATA[
					AND DATE_FORMAT( BUY_COMP_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
				]]>
			</if>
		<![CDATA[ 
				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
		) A JOIN (SELECT @rownumA:=0) rownumA ORDER BY   BUY_COMP_DTM
	) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<select id="selectFrontPayListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
			 SELECT
				COUNT(*) CNT
				
			FROM (
			
				SELECT
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d %H:%i:%S') AS BUY_COMP_DTM,
					PUB.BUY_NO,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND (BUY_REFU_YN = 'N' || BUY_REFU_YN = 'R') ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '화상'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '채팅'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '이메일'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.BUY_PRDT_CD,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN ( SELECT LECT_NM FROM PPM_PRDT_LECT WHERE LECT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN ( SELECT FACE_NM FROM PPM_PRDT_FACE WHERE FACE_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN ( SELECT CHAT_NM FROM PPM_PRDT_CHAT WHERE CHAT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN ( SELECT MAIL_NM FROM PPM_PRDT_MAIL WHERE MAIL_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN ( SELECT LIVE_NM FROM PPM_PRDT_LIVE WHERE LIVE_CD = PUB.BUY_PRDT_CD )
						END
					) AS PRDT_NM,
					PU.USER_NM AS MASTER_NM,
					P_CODE.CODE_NM AS PARENT_CODE_NM,
					M_CODE.CODE_NM AS CODE_NM,
					PU_U.USER_NM,
					PU_U.USER_PHONE,
					PUB.BUY_TYPE,
					
					P_COUP.COUP_DISC,
					PUB_CODE.CODE_NM AS COUP_DISC_NM,
					CASH_RECEIPT,
					PUB.COUP_IDX,
					BUY_STAT,
					
					(SELECT PIP.INFO_TUMB_UUID 
						FROM PPM_INFO_PRDT PIP 
						WHERE 
							PIP.CATE_IDX = PRDT.CATE_IDX
							AND 
							PIP.PRDT_CD = (
								CASE 
									WHEN INSTR(PIP.PRDT_CD,'COACHING') = 1 THEN CONCAT('COACHING',PRDT.CATE_IDX) 
									ELSE PIP.PRDT_CD
								END	
							)
							AND PIP.INFO_ORDE = '0'
							AND PIP.INFO_USE_YN = 'Y'
						
							ORDER BY PIP.INFO_IDX DESC 
							LIMIT 1
						
					) AS PRDT_UUID,
					(
						CASE PRDT_TYPE
							WHEN '화상' THEN ''
							WHEN 'VOD' THEN 
												CONCAT(CONVERT((
													SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD
													WHERE PPLD.LECT_IDX = PRDT.PRDT_IDX AND PPLD.VOD_IDX = PPVD.VOD_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y' 
												), CHAR), ' 개')
							WHEN '채팅' THEN ''
							WHEN '이메일' THEN CONCAT(( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ), ' 건')
							WHEN '라이브클래스' THEN ''
						END
					) AS PRDT_CNT,
					BUY_ACCO_NO,
					BUY_COMP_YN,
					BUY_CD
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID, 
					PPM_CATE PC,
					PPM_USER PU,
					PPM_USER PU_U,
					PPM_CODE P_CODE,
					PPM_CODE M_CODE,
					(
				      SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,', ', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
				    ) PRDT
				WHERE
					(PUB.BUY_STAT NOT LIKE '%취소완료%' && PUB.BUY_STAT NOT LIKE '%환불완료%' && PUB.BUY_STAT IS NOT NULL)
				--	PUB.BUY_REFU_YN = 'N'
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PUB.CATE_IDX = PC.CATE_IDX
					AND PC.USER_IDX = PU.USER_IDX
					AND PU_U.USER_IDX = PUB.USER_IDX
					AND P_CODE.CODE_ID = SUBSTR(PC.CODE_ID, 1 , 5)
					AND M_CODE.CODE_ID = PC.CODE_ID
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
					GROUP BY BUY_NO
					
			) MAIN
			WHERE
				BUY_NO_CNT > 0 
		]]>
			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( MASTER_NM LIKE '%${masterNm}%' OR PRDT_NM LIKE '%${masterNm}%' )
				]]>
			</if>
			<if test="startDate not in {null, ''} and endDate not in {null, ''}">
				<![CDATA[
					AND DATE_FORMAT( BUY_COMP_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
				]]>
			</if>
	</select>
	
	<select id="selectBuyNoMultipleList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		 SELECT
				(
					CASE
						WHEN BUY_PRDT_CD LIKE '%VL%' THEN PRDT_USE_DTM
						WHEN BUY_PRDT_CD LIKE '%EN%' THEN PRDT_USE_DTM
						ELSE	(
						 			SELECT
										CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d,%H:%i' ) ,', ',PPT.TIME_RUN, '분')
									FROM
										PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
								)
					END
				) AS PRDT_TIME,
				
				CATE_IDX,	
					
				BUY_COMP_DTM,
				DATEDIFF(
					DATE_FORMAT(
						DATE_ADD(
							DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
							INTERVAL (
								SELECT TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
							) MINUTE )
					, '%Y-%m-%d %H:%i:%S' ),
					(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
					)
				) AS BUY_REFU_DATE_DIFF,
				
				CONVERT( TIMEDIFF(
					DATE_FORMAT(
						DATE_ADD(
							DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
							INTERVAL (
								SELECT TIME_RUN FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
							) MINUTE )
					, '%Y-%m-%d %H:%i:%S' ),
					(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
					)
				), CHAR) AS BUY_REFU_TIME_DIFF,
				(
						SELECT
							DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ' ', PPT.TIME_STR), '%Y-%m-%d %H:%i:%S' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d %H:%i:%S' )
						FROM
							PPM_PRDT_TIME PPT WHERE PPT.TIME_USE_YN = 'Y' AND TIME_IDX = MAIN.TIME_IDX ORDER BY PPT.TIME_RUN
				) AS BUY_END_TIME,
				
				BUY_ORDER_NUMBER, BUY_NO, BUY_IDX, BUY_NO_CNT, PRDT_TYPE, BUY_PRDT_CD, BUY_PRDT_CD AS PRDT_CD,
				PRDT_NM, PRDT_NM1, PRDT_NM2, MASTER_NM, PARENT_CODE_NM, CODE_NM, USER_NM, USER_PHONE,
				BUY_TYPE, BUY_PRIC, REAL_PAY_PRIC, REAL_DISC_PRIC, REAL_CNT, 
				COUP_DISC, COUP_DISC_NM, CASH_RECEIPT, BUY_STAT, PRDT_UUID, BUY_CARD_NO,
				PRDT_CNT, BUY_ACCO_NO, BUY_COMP_YN, BUY_CD, INFO_PRDT_TITL1, INFO_PRDT_TITL2, INFO_TUMB_UUID, INFO_TUMB_UUID_NM, REFUND_TAKE
				
			FROM (
			
				SELECT
					PUB.TIME_IDX,
					PRDT.CATE_IDX,
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM,
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d %H:$i:%S') AS BUY_COMP_DTM_ALL,
					PUB.BUY_NO,
					PUB.BUY_IDX,
					PUB.BUY_ORDER_NUMBER,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND (BUY_REFU_YN = 'N' || BUY_REFU_YN = 'R') ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.BUY_PRDT_CD,
					PRDT_TIME,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN CONCAT(  DATE_FORMAT( PUB.BUY_COMP_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT( DATE_ADD( PUB.BUY_COMP_DTM , INTERVAL PRDT.PRDT_TIME DAY) , '%Y-%m-%d' ), ', ', PRDT.PRDT_TIME, '일' ) 
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN CONCAT(   CONCAT( DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT( DATE_ADD( PUB.BUY_COMP_DTM, INTERVAL SUBSTRING_INDEX( PRDT.PRDT_TIME, ',' , 1 ) DAY ), '%Y-%m-%d' ) ,', ', SUBSTRING_INDEX( SUBSTRING_INDEX( PRDT.PRDT_TIME, ',', 2),',' , -1 )), '회' ) 
							ELSE ''
						END 
					) AS PRDT_USE_DTM,
					
					PRDT.PRDT_NM1, PRDT.PRDT_NM2, CONCAT( PRDT.PRDT_NM1, ' ',PRDT.PRDT_NM2 )  AS PRDT_NM, PU.USER_NM AS MASTER_NM,
					P_CODE.CODE_NM AS PARENT_CODE_NM, M_CODE.CODE_NM AS CODE_NM, PU_U.USER_NM, PU_U.USER_PHONE, PUB.BUY_TYPE, PUB.BUY_PRIC,
					
					CAST( SUM(PUB.REAL_PAY_PRIC) AS CHAR ) REAL_PAY_PRIC,
					CAST( SUM(PUB.REAL_DISC_PRIC)  AS CHAR ) REAL_DISC_PRIC,
					COUNT(0) REAL_CNT,
					
					P_COUP.COUP_DISC,
					PUB_CODE.CODE_NM AS COUP_DISC_NM,
					CASH_RECEIPT,
					PUB.COUP_IDX,
					BUY_STAT,
					IF( PUB.BUY_CARD_NO ='' OR PUB.BUY_CARD_NO IS NULL , 'NOCARD', PUB.BUY_CARD_NO ) BUY_CARD_NO,
					
					(SELECT PIP.INFO_TUMB_UUID 
						FROM PPM_INFO_PRDT PIP 
						WHERE 
							PIP.CATE_IDX = PRDT.CATE_IDX
							AND 
							PIP.PRDT_CD = (
								CASE 
									WHEN INSTR(PIP.PRDT_CD,'COACHING') = 1 THEN CONCAT('COACHING',PRDT.CATE_IDX) 
									ELSE PIP.PRDT_CD
								END	
							)
							AND PIP.INFO_ORDE = '0'
							AND PIP.INFO_USE_YN = 'Y'
						
							ORDER BY PIP.INFO_IDX DESC 
							LIMIT 1
						
					) AS PRDT_UUID,
					
					(
						CASE PRDT_TYPE
							WHEN '1:1화상상담' THEN ''
							WHEN 'VOD' THEN 
												CONCAT(CONVERT((
													SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD
													WHERE PPLD.LECT_IDX = PRDT.PRDT_IDX AND PPLD.VOD_IDX = PPVD.VOD_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y' 
												), CHAR), ' 개')
							WHEN '1:1채팅상담' THEN ''
							WHEN '1:1이메일상담' THEN CONCAT(( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ), ' 건')
							WHEN 'LIVE CLASS' THEN ''
						END
					) AS PRDT_CNT,
					BUY_ACCO_NO,
					BUY_COMP_YN,
					BUY_CD,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL1,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL2,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_TUMB_UUID,
					'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
					
					CASE PRDT.PRDT_TYPE
						WHEN 'VOD' THEN 
							CASE 
								WHEN (SELECT COUNT(0) FROM PPM_USER_BUY_PROG PUBP WHERE PUBP.BUY_IDX = PUB.BUY_IDX) < 2  
										AND IFNULL((SELECT DATEDIFF( PUBP.SYS_REG_DTM, NOW() )   FROM PPM_USER_BUY_PROG PUBP WHERE PUBP.BUY_IDX = PUB.BUY_IDX ORDER BY SYS_REG_DTM ASC LIMIT 1 ),'0') > -3
								THEN 'Y'
								ELSE 'N'
								END
						WHEN '1:1이메일상담' THEN (SELECT IF( COUNT(0) > 0, 'N', 'Y'  ) FROM PPM_USER_BUY_MAIL PUBM WHERE PUBM.BUY_IDX = PUB.BUY_IDX )
						ELSE NULL						
					END REFUND_TAKE
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID, 
					PPM_CATE PC,
					PPM_USER PU,
					PPM_USER PU_U,
					PPM_CODE P_CODE,
					PPM_CODE M_CODE,
					(
				       SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,', ', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
				    ) PRDT
				WHERE
					(PUB.BUY_STAT NOT LIKE '%취소완료%' && PUB.BUY_STAT NOT LIKE '%환불완료%' && PUB.BUY_STAT IS NOT NULL)
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PUB.CATE_IDX = PC.CATE_IDX
					AND PC.USER_IDX = PU.USER_IDX
					AND PU_U.USER_IDX = PUB.USER_IDX
					AND P_CODE.CODE_ID = SUBSTR(PC.CODE_ID, 1 , 5)
					AND M_CODE.CODE_ID = PC.CODE_ID
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
					AND PUB.BUY_NO = #{buyNo}
					GROUP BY BUY_PRDT_CD
			) MAIN
				 
					 
		]]>
	</select>
	
	
	<select id="selectFrontMypagePaymentUserReview" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				REVI_IDX, 
				BUY_IDX, 
				CATE_IDX, 
				USER_IDX, 
				REVI_SCOR, 
				REVI_CNTN, 
				REVI_UUID, 
				REVI_USE_YN, 
				REVI_PUBL_YN, 
				REVI_REPO_CNTN, 
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX, 
				SYS_MOD_DTM
				
				FROM 
					PPM_DEV.PPM_USER_REVI
					
					WHERE
						BUY_IDX = #{buyIdx}
						AND USER_IDX = #{frontLoginIdx}
						AND REVI_USE_YN = 'Y'
			

		]]>
	</select>

	<insert id="insertFrontMypagePaymentReview" parameterType="hashmap" >
		<![CDATA[
			INSERT INTO 
				PPM_DEV.PPM_USER_REVI
				(
				BUY_IDX, 
				CATE_IDX, 
				USER_IDX, 
				REVI_SCOR, 
				
				REVI_CNTN, 
				REVI_UUID, 
				REVI_USE_YN, 
				REVI_PUBL_YN, 
				REVI_REPO_CNTN, 
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX, 
				SYS_MOD_DTM
				)
				VALUES(
				#{buyIdx}, 
				(SELECT CATE_IDX FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx} ), 
				#{frontLoginIdx}, 
				#{reviScor}, 
				
				#{reviCntn}, 
				#{reviUuid}, 
				'Y', 
				'Y',  
				#{reviRepoCntn}, 
				
				#{frontLoginIdx},
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
				#{frontLoginIdx},
				DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
				)


		]]>
	</insert>
	
	<update id="updateFrontMypageRefundAppl" parameterType="hashmap" >
		<![CDATA[
			UPDATE PPM_USER_BUY
				SET 
				BUY_STAT = #{buyStat},
				BUY_REFU_YN =	 #{buyRefuYn},
		]]>
		<if test='buyRefuYn in {"N"}'>
		<![CDATA[
				BUY_REFU_DTM = null,
		]]>
		</if>
		<if test='buyRefuYn not in {"N"}'>
		<![CDATA[
				BUY_REFU_DTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
		]]>
		</if>
		<![CDATA[
				SYS_MOD_IDX = #{frontLoginIdx},
				SYS_MOD_DTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
				WHERE 
					BUY_NO = ( SELECT BUY_NO FROM (
						SELECT BUY_NO 
							FROM 
								PPM_USER_BUY WHERE
								BUY_IDX = #{buyIdx}
					) AS A  )
						
		]]>
	
	</update>

	<select id="selectFrontMypageRefundAppl" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				BUY_IDX,
				CATE_IDX,
				USER_IDX,
				TIME_IDX,
				COUP_IDX,
				BUY_PRDT_CD,
				BUY_CD,
				BUY_ORDER_NUMBER,
				BUY_NO,
				BUY_TYPE,
				BUY_PRIC,
				BUY_ACCO_NO,
				BUY_BANK_CD,
				BUY_COMP_YN,
				BUY_STAT,
				BUY_COMP_DTM,
				BUY_REFU_YN,
				BUY_REFU_REAS,
				BUY_REFU_DTM,
				CASH_RECEIPT,
				CASH_RECEIPT_NM,
				CASH_RECE_WHY,
				CASH_RECE_SID,
				CASH_RECE_KIND,
				CASH_RECE_NO,
				SYS_REG_IDX,
				SYS_REG_DTM,
				SYS_MOD_IDX,
				SYS_MOD_DTM,
				BUY_HALBU,
				BUY_CARD_NO
				
				FROM 
					PPM_DEV.PPM_USER_BUY
						WHERE 
							BUY_NO = (SELECT BUY_NO FROM PPM_USER_BUY PUB WHERE BUY_IDX = #{buyIdx} )
							AND USER_IDX = #{frontLoginIdx}
							AND BUY_REFU_YN != 'Y'						
		]]>
	
	</select>
	
	
<!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 --><!-- 취소/환불내역 -->
	<select id="selectFrontRefundList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.* FROM (
	SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
		SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
		 	SELECT
				BUY_COMP_DTM,
				BUY_REFU_DTM,
				BUY_NO,
				BUY_NO_CNT,
				PRDT_TYPE,
				
				CATE_IDX,
				PRDT_CD,
				P_CODE_NM,
				M_CODE_NM,
				MASTER_NM,
				
				INFO_PRDT_TITL1,
				INFO_PRDT_TITL2,
				INFO_TUMB_UUID,
				INFO_TUMB_UUID_NM,
				BUY_PRIC,
				BUY_STAT,
				BUY_IDX
				
			FROM (

				SELECT
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM,
					DATE_FORMAT(PUB.BUY_REFU_DTM, '%Y-%m-%d %H:%i:%S') AS BUY_REFU_DTM,
					PUB.BUY_NO,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND BUY_REFU_YN = 'Y' ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.CATE_IDX,
					PUB.BUY_PRDT_CD AS PRDT_CD,
					P_CODE.CODE_NM AS P_CODE_NM,
					M_CODE.CODE_NM AS M_CODE_NM,
					PU.USER_NM AS MASTER_NM,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL1,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL2,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_TUMB_UUID,
					'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
					FORMAT(BUY_PRIC , 0) AS BUY_PRIC,
					BUY_STAT,
					PUB.BUY_IDX
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID
						LEFT JOIN PPM_CATE PC ON PUB.CATE_IDX = PC.CATE_IDX
						LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
						LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
						LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
						LEFT JOIN PPM_SALE_CD_VIEW PRDT ON PUB.BUY_PRDT_CD = PRDT.PRDT_CD
				WHERE
					(PUB.BUY_STAT LIKE '%취소완료%' || PUB.BUY_STAT LIKE '%환불완료%' )
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND BUY_COMP_DTM IS NOT NULL
					AND BUY_REFU_DTM IS NOT NULL
					AND BUY_COMP_YN = 'Y'
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
				GROUP BY BUY_NO
			) MAIN
		]]>
			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( USER_NM LIKE '%${masterNm}%' OR PRDT_NM LIKE '%${masterNm}%' )
				]]>
			</if>
			<if test="startDate not in {null, ''} and endDate not in {null, ''}">
				<![CDATA[
					AND DATE_FORMAT( BUY_COMP_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
				]]>
			</if>
		<![CDATA[ 
				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
		) A JOIN (SELECT @rownumA:=0) rownumA ORDER BY   BUY_COMP_DTM
	) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY NUM_DESC DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<select id="selectFrontRefundListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
	 		SELECT
				COUNT(*) CNT
			FROM (

				SELECT
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM,
					DATE_FORMAT(PUB.BUY_REFU_DTM, '%Y-%m-%d %H:%i:%S') AS BUY_REFU_DTM,
					PUB.BUY_NO,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND BUY_REFU_YN = 'Y' ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.CATE_IDX,
					PUB.BUY_PRDT_CD AS PRDT_CD,
					P_CODE.CODE_NM AS P_CODE_NM,
					M_CODE.CODE_NM AS M_CODE_NM,
					PU.USER_NM AS MASTER_NM,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL1,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL2,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_TUMB_UUID,
					'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
					FORMAT(BUY_PRIC , 0) AS BUY_PRIC,
					BUY_STAT
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID
						LEFT JOIN PPM_CATE PC ON PUB.CATE_IDX = PC.CATE_IDX
						LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
						LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
						LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
						LEFT JOIN PPM_SALE_CD_VIEW PRDT ON PUB.BUY_PRDT_CD = PRDT.PRDT_CD
				WHERE
					(PUB.BUY_STAT LIKE '%취소완료%' || PUB.BUY_STAT LIKE '%환불완료%' )
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND BUY_COMP_DTM IS NOT NULL
					AND BUY_REFU_DTM IS NOT NULL
					AND BUY_COMP_YN = 'Y'
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
				GROUP BY BUY_NO
			) MAIN
				 
					 
		]]>
			<if test="masterNm not in {null, ''}">
				<![CDATA[
					AND ( USER_NM LIKE '%${masterNm}%' OR PRDT_NM LIKE '%${masterNm}%' )
				]]>
			</if>
			<if test="startDate not in {null, ''} and endDate not in {null, ''}">
				<![CDATA[
					AND DATE_FORMAT( BUY_COMP_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
				]]>
			</if>
	</select>
	
	
	
	<select id="selectRefundNoMultipleList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		 	SELECT
				BUY_COMP_DTM,
				BUY_REFU_DTM,
				BUY_NO,
				BUY_NO_CNT,
				PRDT_TYPE,
				
				CATE_IDX,
				PRDT_CD,
				P_CODE_NM,
				M_CODE_NM,
				MASTER_NM,
				
				INFO_PRDT_TITL1,
				INFO_PRDT_TITL2,
				INFO_TUMB_UUID,
				INFO_TUMB_UUID_NM,
				BUY_PRIC,
				BUY_STAT,
				BUY_IDX,
				
				PRDT_PRIC_REAL,
				
				REAL_PAY_PRIC,
				REAL_DISC_PRIC,
				REAL_CNT,
				
				CASE WHEN COUP_IDX IS NOT NULL AND COUP_IDX != '' AND COUP_IDX != '0' then
				IFNULL(CONVERT(
					CASE
						WHEN COUP_DISC_NM = '%' THEN CAST( PRDT_PRIC_REAL * (1 - COUP_DISC*0.01) AS UNSIGNED )
						ELSE PRDT_PRIC_REAL - COUP_DISC
					END
				, CHAR),PRDT_PRIC_REAL) 
				ELSE PRDT_PRIC_REAL	END
				
				AS PRDT_PRIC_REAL_ONE,
				BUY_PRIC,
				COUP_IDX,
				COUP_DISC
				
			FROM (

				SELECT
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d') AS BUY_COMP_DTM,
					DATE_FORMAT(PUB.BUY_REFU_DTM, '%Y-%m-%d %H:%i:%S') AS BUY_REFU_DTM,
					PUB.BUY_NO,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND BUY_REFU_YN = 'Y' ) AS BUY_NO_CNT,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN '1:1화상상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN '1:1채팅상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%EN%' THEN '1:1이메일상담'
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
						END
					) AS PRDT_TYPE,
					PUB.CATE_IDX,
					PUB.BUY_PRDT_CD AS PRDT_CD,
					P_CODE.CODE_NM AS P_CODE_NM,
					M_CODE.CODE_NM AS M_CODE_NM,
					PU.USER_NM AS MASTER_NM,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL1,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_PRDT_TITL2,
					(
						CASE
							WHEN PUB.BUY_PRDT_CD LIKE '%VL%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = PUB.BUY_PRDT_CD )
							ELSE (
									SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
									WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PUB.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
						END
					) AS INFO_TUMB_UUID,
					'INFO_TUMB_UUID' AS INFO_TUMB_UUID_NM,
					FORMAT(BUY_PRIC , 0) AS BUY_PRIC,
					BUY_STAT,
					PUB.BUY_IDX,
					
					CAST( SUM(PUB.REAL_PAY_PRIC) AS CHAR ) REAL_PAY_PRIC,
					CAST( SUM(PUB.REAL_DISC_PRIC)  AS CHAR ) REAL_DISC_PRIC,
					COUNT(0) REAL_CNT,
					
					PRDT.PRDT_PRIC_REAL,
					P_COUP.COUP_IDX,
					
					(SELECT PC.CODE_NM FROM PPM_CODE PC WHERE P_COUP.COUP_DISC_CD = PC.CODE_ID ) COUP_DISC_NM,
					P_COUP.COUP_DISC
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID
						LEFT JOIN PPM_CATE PC ON PUB.CATE_IDX = PC.CATE_IDX
						LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
						LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
						LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
						LEFT JOIN PPM_SALE_CD_VIEW PRDT ON PUB.BUY_PRDT_CD = PRDT.PRDT_CD
				WHERE
					(PUB.BUY_STAT LIKE '%취소완료%' || PUB.BUY_STAT LIKE '%환불완료%' )
					AND PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND BUY_COMP_DTM IS NOT NULL
					AND BUY_REFU_DTM IS NOT NULL
					AND BUY_COMP_YN = 'Y'
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
					AND PUB.BUY_NO = #{buyNo}
					GROUP BY BUY_PRDT_CD
			) MAIN
		]]>
	</select>

	<select id="selectFrontMypagePrdtBaskData" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		 	SELECT 
		 		BASK_IDX, 
		 		BASK_PRDT_CD, 
		 		USER_IDX, 
		 		CATE_IDX, 
		 		BASK_TYPE, 
		 		BASK_USE_YN, 
		 		TIME_IDX, 
		 		SYS_REG_IDX, 
		 		SYS_REG_DTM, 
		 		SYS_MOD_IDX, 
		 		SYS_MOD_DTM
		 		
				FROM 
					PPM_DEV.PPM_PRDT_BASK
					
					WHERE
						BASK_PRDT_CD = ( SELECT BUY_PRDT_CD FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx} )
						AND CATE_IDX = ( SELECT CATE_IDX FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx} )
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = 'B'
						AND BASK_USE_YN = 'Y'
		 	
		]]>
	</select>

	<select id="selectFrontMypageRefundPrdtData" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
 SELECT
				BUY_COMP_DTM,
				BUY_NO,
				BUY_IDX,
				BUY_NO_CNT,
				BUY_PRDT_CD,
				
				BUY_TYPE,
				IFNULL(CONVERT(
					CASE
						WHEN COUP_DISC_NM = '%' THEN CAST( PRDT_PRIC_REAL * (1 - COUP_DISC*0.01) AS UNSIGNED )
						ELSE PRDT_PRIC_REAL - COUP_DISC
					END
				, CHAR),PRDT_PRIC_REAL) AS PRDT_PRIC_REAL,
				BUY_PRIC,
				PRDT_PRIC_REAL2,
				PRDT_PRIC,
				
				IFNULL(CONVERT(
					CASE
						WHEN COUP_DISC_NM = '%' THEN CAST( PRDT_PRIC_REAL_ONE * (1 - COUP_DISC*0.01) AS UNSIGNED )
						ELSE PRDT_PRIC_REAL_ONE - COUP_DISC
					END
				, CHAR),PRDT_PRIC_REAL_ONE) AS PRDT_PRIC_REAL_ONE,
				
				BUY_HALBU,       
				BUY_CARD_NO,     
				BUY_ACCO_NO,     
				BUY_BANK_CD,     
				
				COUP_DISC,
				COUP_DISC_NM,
				CASH_RECEIPT,
				BUY_REFU_DTM,
				BUY_CD,
				
				REAL_PAY_PRIC,
				REAL_DISC_PRIC,
				REAL_CNT
				
			FROM (
			
				SELECT
					DATE_FORMAT(PUB.BUY_COMP_DTM, '%Y-%m-%d ') AS BUY_COMP_DTM,
					PUB.BUY_NO,
					PUB.BUY_IDX,
					( SELECT COUNT(0) FROM PPM_USER_BUY WHERE BUY_NO = PUB.BUY_NO AND BUY_REFU_YN = 'Y' ) AS BUY_NO_CNT,
					
					PUB.BUY_PRDT_CD,
					
					PRDT.PRDT_NM1,
					PRDT.PRDT_NM2,
					
					CONCAT( PRDT.PRDT_NM1, ' ',PRDT.PRDT_NM2 )  AS PRDT_NM,
					
					PU.USER_NM AS MASTER_NM,
					P_CODE.CODE_NM AS PARENT_CODE_NM,
					M_CODE.CODE_NM AS CODE_NM,
					PU_U.USER_NM,
					PU_U.USER_PHONE,
					PUB.BUY_TYPE,
					
					PUB.BUY_HALBU,
					PUB.BUY_CARD_NO,
					PUB.BUY_ACCO_NO,
					PUB.BUY_BANK_CD,
					
					(
						SELECT
							SUM(PRDT_PRIC_REAL)
						FROM
							(
								SELECT CATE_IDX, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_CD AS BUY_PRDT_CD FROM PPM_PRDT_FACE WHERE FACE_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_CD AS BUY_PRDT_CD FROM PPM_PRDT_LECT WHERE LECT_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_CD AS BUY_PRDT_CD FROM PPM_PRDT_CHAT WHERE CHAT_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_CD AS BUY_PRDT_CD FROM PPM_PRDT_MAIL WHERE MAIL_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_CD AS BUY_PRDT_CD FROM PPM_PRDT_LIVE WHERE LIVE_USE_YN = 'Y'
							) PRDT_SUB
						WHERE
							PRDT_SUB.BUY_PRDT_CD IN ( SELECT BUY_PRDT_CD FROM PPM_USER_BUY WHERE BUY_REFU_YN = 'N' AND BUY_NO = PUB.BUY_NO )
					) AS PRDT_PRIC_REAL,
					PUB.BUY_PRIC,
					
					(
						SELECT
							SUM(PRDT_PRIC_REAL)
						FROM
							(
								SELECT CATE_IDX, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_CD AS BUY_PRDT_CD FROM PPM_PRDT_FACE WHERE FACE_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_CD AS BUY_PRDT_CD FROM PPM_PRDT_LECT WHERE LECT_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_CD AS BUY_PRDT_CD FROM PPM_PRDT_CHAT WHERE CHAT_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_CD AS BUY_PRDT_CD FROM PPM_PRDT_MAIL WHERE MAIL_USE_YN = 'Y'
									UNION ALL
								SELECT CATE_IDX, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_CD AS BUY_PRDT_CD FROM PPM_PRDT_LIVE WHERE LIVE_USE_YN = 'Y'
							) PRDT_SUB
						WHERE
							PRDT_SUB.BUY_PRDT_CD = PUB.BUY_PRDT_CD 
					) AS PRDT_PRIC_REAL_ONE,
					PRDT.PRDT_PRIC_REAL PRDT_PRIC_REAL2,
					PRDT.PRDT_PRIC PRDT_PRIC,
					
					P_COUP.COUP_DISC,
					PUB_CODE.CODE_NM AS COUP_DISC_NM,
					CASH_RECEIPT,
					PUB.COUP_IDX,
					DATE_FORMAT(PUB.BUY_REFU_DTM, '%Y-%m-%d ') BUY_REFU_DTM,
					
					BUY_CD,
					
					CAST( SUM(PUB.REAL_PAY_PRIC) AS CHAR ) REAL_PAY_PRIC,
					CAST( SUM(PUB.REAL_DISC_PRIC)  AS CHAR ) REAL_DISC_PRIC,
					COUNT(0) REAL_CNT
					
				FROM
					PPM_USER_BUY PUB
						LEFT JOIN PPM_USER_COUP PUC ON PUB.COUP_IDX = PUC.COUP_IDX
						LEFT JOIN PPM_COUP_DATA PCD ON PUC.DATA_IDX  = PCD.DATA_IDX 
						LEFT JOIN PPM_COUP P_COUP ON PCD.COUP_IDX  = P_COUP.COUP_IDX
						LEFT JOIN PPM_CODE PUB_CODE ON P_COUP.COUP_DISC_CD  = PUB_CODE.CODE_ID, 
					PPM_CATE PC,
					PPM_USER PU,
					PPM_USER PU_U,
					PPM_CODE P_CODE,
					PPM_CODE M_CODE,
					(
				       SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,', ', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),', ',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
				    ) PRDT
				WHERE
					PUB.BUY_NO IS NOT NULL
					AND PUB.BUY_TYPE IS NOT NULL
					
					AND PUB.CATE_IDX = PC.CATE_IDX
					AND PC.USER_IDX = PU.USER_IDX
					AND PU_U.USER_IDX = PUB.USER_IDX
					AND P_CODE.CODE_ID = SUBSTR(PC.CODE_ID, 1 , 5)
					AND M_CODE.CODE_ID = PC.CODE_ID
					
					AND PRDT.CATE_IDX = PUB.CATE_IDX
					AND PRDT.CATE_IDX = PC.CATE_IDX
					AND PUB.BUY_PRDT_CD = PRDT.PRDT_CD
					
					AND PUB.USER_IDX = #{frontLoginIdx }
					
					AND PUB.BUY_PRDT_CD = #{prdtCd}
					AND PUB.BUY_NO = (SELECT BUY_NO FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx})
					
					GROUP BY BUY_PRDT_CD
			) MAIN
				 
					 
		 	
		]]>
	</select>

	<insert id="insertFrontMypagePrdtBaskData" parameterType="hashmap" >
		<![CDATA[
		 	INSERT INTO 
					PPM_DEV.PPM_PRDT_BASK
					(
					BASK_PRDT_CD, 
					USER_IDX, 
					CATE_IDX,
					BASK_TYPE,
					BASK_USE_YN,
					SYS_REG_IDX, 
					SYS_REG_DTM, 
					SYS_MOD_IDX, 
					SYS_MOD_DTM
					)
					VALUES
					(
					( SELECT BUY_PRDT_CD FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx} ),
					#{frontLoginIdx},
					( SELECT CATE_IDX FROM PPM_USER_BUY WHERE BUY_IDX = #{buyIdx} ),
					'B',
					'Y',
					#{frontLoginIdx}, 
					DATE_FORMAT( now(), '%Y-%m-%d %H:%i:%S'),
					#{frontLoginIdx},
					DATE_FORMAT( now(), '%Y-%m-%d %H:%i:%S')
					)

		 	
		]]>
	</insert>
	
	
	
	
<!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 --><!-- 	내쿠폰 -->
	<select id="selectFrontCoupList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.* FROM (
	SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
		SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
			
			SELECT
				COUP_IDX,
				DATA_IDX,
				U_COUP_IDX,
				COUP_DATA_CD,
				COUP_UUID,
				COUP_NM,
				CONCAT( COUP_MINI, COUP_MINI_TYPE ) AS COUP_MINI,
				COUP_CATE_CD,
				CONCAT(COUP_STR_DTM, ' ~ ') AS COUP_STR_DTM,
				COUP_END_DTM,
				COUP_USE_YN,
				COUP_CNT,
				COUP_REST_DTM,
				COUP_DISC,
				COUP_DISC_CD
			FROM (
				SELECT
					PC.COUP_IDX,
					PCD.DATA_IDX,
					PUC.COUP_IDX AS U_COUP_IDX,
					PCD.COUP_DATA_CD,
					PC.COUP_UUID,
					PC.COUP_NM,
					FORMAT(PC.COUP_MINI , 0) AS COUP_MINI,
					(
						CASE
							WHEN PC.COUP_MINI_TYPE = 'U' THEN '원 이상'
							WHEN PC.COUP_MINI_TYPE = 'D' THEN '원 이하'
						END
					) AS COUP_MINI_TYPE,
					PC.COUP_CATE_CD,
					DATE_FORMAT( PC.COUP_STR_DTM, '%Y-%m-%d') AS COUP_STR_DTM,
					DATE_FORMAT( PC.COUP_END_DTM, '%Y-%m-%d') AS COUP_END_DTM,
					(
						CASE
							WHEN PUC.COUP_USE_YN = 'N'
							THEN (
									CASE
										WHEN DATE_FORMAT( PC.COUP_END_DTM, '%Y-%m-%d') = '0000-00-00' THEN 'N'
										WHEN DATEDIFF(DATE_FORMAT( PC.COUP_END_DTM, '%Y-%m-%d'), NOW()) > 0 THEN 'N'
										ELSE 'O'
									END
								)
							WHEN PUC.COUP_USE_YN = 'Y' THEN 'Y'
							WHEN PUC.COUP_USE_YN IS NULL THEN (
									CASE
										WHEN COUP_KIND = 'COU02' AND PUC.COUP_IDX IS NULL THEN 'D'
										ELSE NULL
									END
								)
										
						END
					) AS COUP_USE_YN,
					(
						SELECT
							COUNT(0)
							FROM
							PPM_USER_COUP PUC_SUB,
							PPM_COUP_DATA PCD_SUB,
							PPM_COUP PC_SUB
						WHERE
							PUC_SUB.DATA_IDX = PCD_SUB.DATA_IDX
							AND PCD_SUB.COUP_IDX = PC_SUB.COUP_IDX
							AND PUC_SUB.USER_IDX = PUC.USER_IDX
							AND PUC_SUB.COUP_DEL_YN = 'N'
							AND PUC_SUB.COUP_USE_YN = 'N'
							AND PCD_SUB.DATA_USE_YN = 'Y'
							AND DATEDIFF( DATE_ADD( DATE_FORMAT(PUC_SUB.SYS_REG_DTM, '%Y-%m-%d') , INTERVAL PC_SUB.COUP_USE_DATE DAY ) , NOW()) > 0 
					) AS COUP_CNT,
					(
						SELECT
							DATEDIFF( DATE_ADD( DATE_FORMAT(PUC_SUB.SYS_REG_DTM, '%Y-%m-%d') , INTERVAL PC_SUB.COUP_USE_DATE DAY ) , NOW())
							FROM
							PPM_USER_COUP PUC_SUB,
							PPM_COUP_DATA PCD_SUB,
							PPM_COUP PC_SUB
						WHERE
							PUC_SUB.DATA_IDX = PCD_SUB.DATA_IDX
							AND PCD_SUB.COUP_IDX = PC_SUB.COUP_IDX
							AND PUC_SUB.USER_IDX = PUC.USER_IDX
							AND PUC_SUB.COUP_DEL_YN = 'N'
							AND PUC_SUB.COUP_USE_YN = 'N'
							AND PCD_SUB.DATA_USE_YN = 'Y'
							AND DATEDIFF( DATE_ADD( DATE_FORMAT(PUC_SUB.SYS_REG_DTM, '%Y-%m-%d') , INTERVAL PC_SUB.COUP_USE_DATE DAY ) , NOW()) > 0
							AND PC_SUB.COUP_IDX = PC.COUP_IDX 
					) AS COUP_REST_DTM,
					PC.COUP_DISC ,
					(SELECT CODE_NM FROM PPM_CODE WHERE PC.COUP_DISC_CD = CODE_ID ) COUP_DISC_CD
					
						
				FROM
					PPM_COUP PC
						LEFT JOIN PPM_COUP_DATA PCD ON PC.COUP_IDX = PCD.COUP_IDX
						LEFT OUTER JOIN PPM_USER_COUP PUC ON PCD.DATA_IDX = PUC.DATA_IDX 
				WHERE
					PC.COUP_USE_YN = 'Y'
					AND PCD.DATA_USE_YN = 'Y'
					AND (PUC.COUP_DEL_YN = 'N' || PUC.COUP_DEL_YN IS NULL )
				--	AND ( PC.COUP_KIND = '다운로드형' OR PC.COUP_KIND = '다운로드형' OR COUP_TYPE = 'CPT02' )
					AND ( PCD.USER_IDX = #{frontLoginIdx } OR PUC.USER_IDX = #{frontLoginIdx } )
			) MAIN
				WHERE COUP_IDX IS NOT NULL
	]]>
		<if test="masterNm not in {null, ''}">
			<![CDATA[
				AND USER_NM = #{masterNm}
			]]>
		</if>
		<if test="startDate not in {null, ''} and endDate not in {null, ''}">
			<![CDATA[
				AND DATE_FORMAT( BUY_REG_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
			]]>
		</if>
	<![CDATA[ 

				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
		) A JOIN (SELECT @rownumA:=0) rownumA
	) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY COUP_IDX DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<select id="selectFrontCoupListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT
				COUNT(0) AS CNT
			FROM (
				SELECT
					PC.COUP_IDX,
					PCD.DATA_IDX,
					PUC.COUP_IDX AS U_COUP_IDX,
					PCD.COUP_DATA_CD,
					PC.COUP_UUID,
					PC.COUP_NM,
					FORMAT(PC.COUP_MINI , 0) AS COUP_MINI,
					(
						CASE
							WHEN PC.COUP_MINI_TYPE = 'U' THEN '원 이상'
							WHEN PC.COUP_MINI_TYPE = 'D' THEN '원 이하'
						END
					) AS COUP_MINI_TYPE,
					PC.COUP_CATE_CD,
					DATE_FORMAT( PC.COUP_STR_DTM, '%Y-%m-%d') AS COUP_STR_DTM,
					DATE_FORMAT( PC.COUP_END_DTM, '%Y-%m-%d') AS COUP_END_DTM,
					(
						CASE
							WHEN PUC.COUP_USE_YN = 'N'
							THEN (
									CASE
										WHEN DATEDIFF(DATE_FORMAT( PC.COUP_END_DTM, '%Y-%m-%d'), NOW()) > 0 THEN 'N'
										ELSE 'O'
									END
								)
							WHEN PUC.COUP_USE_YN = 'Y' THEN 'Y'
							WHEN PUC.COUP_USE_YN IS NULL THEN (
									CASE
										WHEN COUP_KIND = 'COU02' AND PUC.COUP_IDX IS NULL THEN 'D'
										ELSE NULL
									END
								)
										
						END
					) AS COUP_USE_YN,
					(
						SELECT
							COUNT(0)
							FROM
							PPM_USER_COUP PUC_SUB,
							PPM_COUP_DATA PCD_SUB,
							PPM_COUP PC_SUB
						WHERE
							PUC_SUB.DATA_IDX = PCD_SUB.DATA_IDX
							AND PCD_SUB.COUP_IDX = PC_SUB.COUP_IDX
							AND PUC_SUB.USER_IDX = PUC.USER_IDX
							AND PUC_SUB.COUP_DEL_YN = 'N'
							AND PUC_SUB.COUP_USE_YN = 'N'
							AND PCD_SUB.DATA_USE_YN = 'Y'
							AND DATEDIFF(DATE_FORMAT(PC_SUB.COUP_END_DTM, '%Y-%m-%d'), NOW()) > 0
							AND PC_SUB.COUP_IDX = PC.COUP_IDX
						) AS COUP_CNT
				FROM
					PPM_COUP PC
						LEFT JOIN PPM_COUP_DATA PCD ON PC.COUP_IDX = PCD.COUP_IDX
						LEFT OUTER JOIN PPM_USER_COUP PUC ON PCD.DATA_IDX = PUC.DATA_IDX 
				WHERE
					PC.COUP_USE_YN = 'Y'
					AND PCD.DATA_USE_YN = 'Y'
					AND (PUC.COUP_DEL_YN = 'N' || PUC.COUP_DEL_YN IS NULL )
					AND ( PCD.USER_IDX = #{frontLoginIdx } OR PUC.USER_IDX = #{frontLoginIdx } )
					
				) MAIN
				WHERE	COUP_USE_YN IS NOT NULL
					
		]]>
			<if test="prdtType not in {null, ''}">
				<![CDATA[
					AND PRDT_TYPE = #{prdtType}
				]]>
			</if>
			<if test="timeDtmSrt not in {null, ''} and timeDtmEnd not in {null, ''}">
				<![CDATA[
					AND DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) BETWEEN #{timeDtmSrt} AND #{timeDtmEnd} 
				]]>
			</if>
	</select>
	
	<select id="selectFrontCoupData" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				PCD.DATA_IDX,
				CONVERT( ( SELECT COUNT(0) FROM PPM_USER_COUP WHERE DATA_IDX = PCD.DATA_IDX AND  PPM_USER_COUP.COUP_DEL_YN = 'N' AND USER_IDX = #{frontLoginIdx } ), CHAR ) AS COUP_CNT
			FROM
				PPM_COUP_DATA PCD
					LEFT JOIN PPM_COUP PC ON PCD.COUP_IDX = PC.COUP_IDX
			WHERE
				PCD.DATA_USE_YN = 'Y'
				AND PCD.COUP_DATA_CD = #{coupCode }
		]]>
	</select>
	
	<insert id="inserFrontCoupData" parameterType="hashmap">
		<![CDATA[
		INSERT INTO 
			PPM_USER_COUP
				(
					USER_IDX, 
					DATA_IDX, 
					COUP_USE_YN, 
					COUP_DEL_YN,
					
					SYS_REG_IDX,
					SYS_REG_DTM, 
					SYS_MOD_IDX, 
					SYS_MOD_DTM
				) VALUES (
					#{frontLoginIdx }, 
					#{dataIdx }, 
					'N', 
					'N', 
					
					#{frontLoginIdx}, 
					DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'), 
					#{frontLoginIdx}, 
					DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
				)
		]]>
</insert>	

<!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 --><!-- 1:1문의	 -->
	<select id="selectFrontInquList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
SELECT C.* FROM (
	SELECT B.*, (@rownumB:=@rownumB+1) as NUM_ASC FROM(  
		SELECT A.*, (@rownumA:=@rownumA+1) as NUM_DESC FROM (
				]]>
			</if>
		<![CDATA[
			
			SELECT
				QNA_IDX,
				QNA_NAME,
				CODE_NM,
				QNA_TITL,
				(
					CASE 
						WHEN LENGTH(QNA_CNTN) > 45 THEN CONCAT(SUBSTR(QNA_CNTN,1,45),'...')
						ELSE QNA_CNTN
					END
				) AS QNA_CNTN,
				LENGTH(QNA_REPL) AS QNA_REPL,
				DATE_FORMAT( PSQ.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM
			FROM
				PPM_SITE_QNA PSQ,
				PPM_CODE PC
			WHERE
				QNA_CD = CODE_ID
				AND PSQ.SYS_REG_IDX = #{frontLoginIdx }
	]]>
		<if test="qnaTitl not in {null, ''}">
			<![CDATA[
				AND QNA_CNTN LIKE '%${qnaTitl}%'
			]]>
		</if>
		<if test="startDate not in {null, ''} and endDate not in {null, ''}">
			<![CDATA[
				AND DATE_FORMAT( PSQ.SYS_REG_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
			]]>
		</if>
	<![CDATA[ 

				
				]]>
			<if test="status not in {'LIST'}">
				<![CDATA[
		) A JOIN (SELECT @rownumA:=0) rownumA
	) B JOIN (SELECT @rownumB:=0) rownumB ORDER BY QNA_IDX DESC
) C WHERE NUM_ASC BETWEEN #{startRow } AND #{endRow }
				]]>
			</if>
		<![CDATA[
		]]>
	</select>
	
	<select id="selectFrontInquListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT
				COUNT(0) AS CNT
			FROM
				PPM_SITE_QNA PSQ,
				PPM_CODE PC
			WHERE
				QNA_CD = CODE_ID
				AND PSQ.SYS_REG_IDX = #{frontLoginIdx }
	]]>
		<if test="qnaTitl not in {null, ''}">
			<![CDATA[
				AND QNA_TITL LIKE '%${qnaTitl}%'
			]]>
		</if>
		<if test="startDate not in {null, ''} and endDate not in {null, ''}">
			<![CDATA[
				AND DATE_FORMAT( PSQ.SYS_REG_DTM, '%Y-%m-%d' ) BETWEEN #{startDate} AND #{endDate} 
			]]>
		</if>
	</select>
	
	<select id="selectFrontInquDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				QNA_IDX,
				
				CODE_NM,
				QNA_TITL,
				DATE_FORMAT( PSQ.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
				QNA_CNTN,
				QNA_USER_UUID,
				QNA_REPL,
				QNA_MNG_UUID
			FROM
				PPM_SITE_QNA PSQ,
				PPM_CODE PC
			WHERE
				QNA_CD = CODE_ID
				AND PSQ.SYS_REG_IDX = #{frontLoginIdx }
				AND QNA_IDX = #{qnaIdx }
		]]>
	</select>
	
	
<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->	
<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->	
<!-- //////////////////////////////////////////////////////////////최우성/////////////////////////////////////////////////////////////////// -->	
<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->	
<!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
	
	<select id="selectFrontCartList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		 
			SELECT
				*
			FROM (
				SELECT DISTINCT
					BASK_IDX,
					(SELECT BASK_USE_YN FROM PPM_PRDT_BASK PPB2 WHERE PPB2.BASK_TYPE != 'B' AND PC.CATE_IDX = PPB2.CATE_IDX AND PPB2.BASK_PRDT_CD = PPB.BASK_PRDT_CD AND PPB2.USER_IDX = PPB.USER_IDX LIMIT 1  ) JJIM_USE_YN,
					(SELECT BASK_IDX FROM PPM_PRDT_BASK PPB2 WHERE PPB2.BASK_TYPE != 'B' AND PC.CATE_IDX = PPB2.CATE_IDX AND PPB2.BASK_PRDT_CD = PPB.BASK_PRDT_CD AND PPB2.USER_IDX = PPB.USER_IDX LIMIT 1 ) JJIM_IDX,
					DATE_FORMAT( PPB.SYS_REG_DTM, '%Y-%m-%d') AS SYS_REG_DTM,
					PPB.CATE_IDX,
					
					PPB.BASK_PRDT_CD AS PRDT_CD,
					PU.USER_NM,
					(
						CASE
							WHEN PRDT.PRDT_CD LIKE '%VL%' THEN 'VOD'
							WHEN PRDT.PRDT_CD LIKE '%LN%' THEN 'LIVE CLASS'
							WHEN PRDT.PRDT_CD LIKE '%FN%' THEN '1:1화상상담'
							WHEN PRDT.PRDT_CD LIKE '%CN%' THEN '1:1채팅상담'
							WHEN PRDT.PRDT_CD LIKE '%EN%' THEN '1:1이메일상담'
						END
					) AS PRDT_TYPE,
					(
						CASE
							WHEN PRDT.PRDT_CD LIKE '%VL%' THEN CONCAT(CONVERT((
													SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD
													WHERE PPLD.LECT_IDX = PRDT.PRDT_IDX AND PPLD.VOD_IDX = PPVD.VOD_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y' 
												), CHAR), ' 개')
							WHEN PRDT.PRDT_CD LIKE '%LN%' THEN ''
							WHEN PRDT.PRDT_CD LIKE '%FN%' THEN ''
							WHEN PRDT.PRDT_CD LIKE '%CN%' THEN ''
							WHEN PRDT.PRDT_CD LIKE '%EN%' THEN CONCAT(( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ), ' 건')
						END
					) AS PRDT_CNT,
					
					PRDT_TIME,
					
					(
						CASE
							WHEN PRDT_CD LIKE '%VL%' THEN CONCAT(  PRDT.PRDT_TIME, '일' ) 
							WHEN PRDT_CD LIKE '%FN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
							WHEN PRDT_CD LIKE '%CN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
							WHEN PRDT_CD LIKE '%EN%' THEN CONCAT(   PRDT.PRDT_TIME, '회' ) 
							WHEN PRDT_CD LIKE '%LN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
						END 
					) AS PRDT_USE_DTM,
					
					FORMAT(PRDT_PRIC , 0) AS PRDT_PRIC,
					FORMAT(PRDT_PRIC_REAL , 0) AS PRDT_PRIC_REAL,
					PRDT_PRIC  AS PRDT_PRIC_NOCOMMA,
					PRDT_PRIC_REAL AS PRDT_PRIC_REAL_NOCOMMA,
					 
					(
				      CASE
				        WHEN PRDT.PRDT_CD LIKE '%VL%' THEN (
				            SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        WHEN PRDT.PRDT_CD LIKE '%LN%' THEN (
				            SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        ELSE (
				            SELECT DISTINCT INFO_PRDT_TITL1 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
				      END
				    ) AS INFO_PRDT_TITL1,
				    (
				      CASE
				        WHEN PRDT.PRDT_CD LIKE '%VL%' THEN (
				            SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        WHEN PRDT.PRDT_CD LIKE '%LN%' THEN (
				            SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        ELSE (
				            SELECT DISTINCT INFO_PRDT_TITL2 FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
				      END
				    ) AS INFO_PRDT_TITL2,
				    (
				      CASE
				        WHEN PRDT.PRDT_CD LIKE '%VL%' THEN (
				            SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        WHEN PRDT.PRDT_CD LIKE '%LN%' THEN (
				            SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = PRDT.PRDT_CD )
				        ELSE (
				            SELECT DISTINCT INFO_TUMB_UUID FROM PPM_INFO_PRDT
				            WHERE INFO_USE_YN = 'Y' AND INFO_ORDE = 0 AND CATE_IDX = PRDT.CATE_IDX AND PRDT_CD = CONCAT('COACHING',CATE_IDX) )
				      END
				    ) AS INFO_TUMB_UUID,
				    'INFO_TUMB_UUID_FILE' AS INFO_TUMB_UUID_NM,
					
					P_CODE.CODE_NM AS P_CODE_NM,
					M_CODE.CODE_NM AS M_CODE_NM,
					PRDT_DISC,
					PPCV_CODE.CODE_NM AS PRDT_DISC_NM,
					BASK_CNT,
					(SELECT COUNT(0)
						FROM PPM_PRDT_TIME PPT 
						WHERE PRDT.PRDT_IDX = 
								CASE 
									WHEN PRDT.PRDT_CD LIKE '%CN%' THEN PPT.CHAT_IDX 
									WHEN PRDT.PRDT_CD LIKE '%FN%' THEN PPT.FACE_IDX 
									WHEN PRDT.PRDT_CD LIKE '%LN%' THEN PPT.LIVE_IDX 
									ELSE ''
								END 
						AND TIMESTAMPDIFF(HOUR , DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i' ), DATE_FORMAT(CONCAT(PPT.TIME_DTM, ' ',PPT.TIME_STR ),'%Y-%m-%d %H:%i' ) ) > 0
						AND PPT.TIME_USE_YN = 'Y'
						AND CASE
								WHEN PRDT.PRDT_CD LIKE '%LN%' THEN (SELECT COUNT(0) FROM PPM_USER_BUY PUB3 WHERE PPT.TIME_IDX = PUB3.TIME_IDX ) < (SELECT LIVE_CNT FROM PPM_PRDT_LIVE PPL2 WHERE PPL2.LIVE_IDX = PPT.LIVE_IDX)
								ELSE (SELECT COUNT(0) FROM PPM_USER_BUY PUB3 WHERE PPT.TIME_IDX = PUB3.TIME_IDX ) = 0
							END
					) NO_USE_TIME_CNT
					
				FROM
					PPM_PRDT_BASK PPB
						LEFT JOIN PPM_CATE PC ON PPB.CATE_IDX = PC.CATE_IDX
						LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
						LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
						LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
						
						LEFT JOIN 
						(
					    SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d,%H:%i' ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD,  FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC , FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM, FACE_DISC AS PRDT_DISC, FACE_DISC_CD AS PRDT_DISC_CD
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y' AND PPF.FACE_STAT_CD = 'SAL02'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM, LECT_DISC AS PRDT_DISC, LECT_DISC_CD AS PRDT_DISC_CD
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y' AND PPLE.LECT_STAT_CD = 'SAL02'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d,%H:%i' ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM, CHAT_DISC AS PRDT_DISC, CHAT_DISC_CD AS PRDT_DISC_CD
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y' AND PPC.CHAT_STAT_CD = 'SAL02'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( PPM.MAIL_DTM_CNT, '일 ,' , PPM.MAIL_CNT )  AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM, MAIL_DISC AS PRDT_DISC, MAIL_DISC_CD AS PRDT_DISC_CD
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y' AND PPM.MAIL_STAT_CD = 'SAL02'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_FORMAT( DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ), '%Y-%m-%d,%H:%i' ),',',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM, LIVE_DISC AS PRDT_DISC, LIVE_DISC_CD AS PRDT_DISC_CD
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y' AND PPLI.LIVE_STAT_CD = 'SAL02'
					    ) PRDT
						 ON PPB.BASK_PRDT_CD = PRDT.PRDT_CD
						 
						LEFT JOIN PPM_CODE PPCV_CODE ON PPCV_CODE.CODE_ID = PRDT.PRDT_DISC_CD
				WHERE
					PPB.BASK_USE_YN = 'Y'
					AND PPB.BASK_TYPE= #{baskType}
					AND PPB.USER_IDX = #{userIdx}
				) MAIN
			WHERE
				BASK_IDX IS NOT NULL
				AND INFO_PRDT_TITL1 IS NOT NULL
		 
		]]>
	</select>
	
	<update id="deleteFrontCartData" parameterType="hashmap">
		<![CDATA[	
			UPDATE
				PPM_PRDT_BASK
					SET 
						BASK_USE_YN = 'N',
						SYS_MOD_IDX=#{frontLoginIdx},
						SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
					
					WHERE
						BASK_IDX = #{baskIdx}
					
		]]>
	</update>

	<update id="updateFrontDibsData" parameterType="hashmap">
		<![CDATA[	
			UPDATE
				PPM_PRDT_BASK
					SET 
						BASK_USE_YN = #{baskUseYn},
						BASK_CNT = '1',
						SYS_MOD_IDX=#{frontLoginIdx},
						SYS_MOD_DTM=DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
					
					WHERE
						BASK_IDX = #{baskIdx}
					
		]]>
	</update>

	<insert id="insertFrontDibsData" parameterType="hashmap">
	
		<![CDATA[	
			INSERT INTO 
				PPM_PRDT_BASK
					(
					BASK_PRDT_CD,
					USER_IDX,
					CATE_IDX,
					BASK_TYPE, 
					BASK_USE_YN,
					BASK_CNT,
					SYS_REG_IDX, 
					SYS_REG_DTM,
					SYS_MOD_IDX,
					SYS_MOD_DTM
					)
					VALUES
					(
					( SELECT BASK_PRDT_CD FROM (SELECT BASK_PRDT_CD FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx}) AS A ),
					#{frontLoginIdx},
					( SELECT CATE_IDX FROM (SELECT CATE_IDX FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx}) AS B ),
		]]>
		<choose>
			<when test='baskType in { "B" } '>
			<![CDATA[	
						'K',
			]]>
			</when>
			<when test='baskType in { "K"  }'>
				<![CDATA[	
						'B',
				]]>
			</when>		
			<otherwise>
				<![CDATA[	
						'',
				]]>
			</otherwise>
		</choose>
					
		<![CDATA[	
					'Y',
					'1',
					#{frontLoginIdx},
					DATE_FORMAT(NOW(), '%Y%m%d%H%i%S'),
					#{frontLoginIdx},
					DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
					)
					
					
	]]>
	
	</insert>
	
	<select id="selectFrontUserCoupList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			
			 
		 SELECT 
			PUC.COUP_IDX ,
			PUC.DATA_IDX ,
			PUC.USER_IDX ,
			DATE_FORMAT( PUC.SYS_REG_DTM , '%Y-%m-%d'),
			PCD.COUP_DATA_CD ,
			(SELECT CODE_NM FROM PPM_CODE PC WHERE PC.CODE_ID = PC.COUP_DISC_CD) COUP_DISC_CD_NM,
			PC.COUP_NM ,
			PC.COUP_DISC ,
			PC.COUP_DISC_CD ,
			DATE_FORMAT( PC.COUP_END_DTM , '%Y-%m-%d'),
			PC.COUP_MINI ,
			PC.COUP_MINI_TYPE ,
			PC.COUP_CATE_CD ,
			DATE_FORMAT( PC.COUP_STR_DTM , '%Y-%m-%d'),
			PC.COUP_UUID 
				FROM
					PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC 
						WHERE
							PUC.DATA_IDX  = PCD.DATA_IDX 
							AND PCD.COUP_IDX  = PC.COUP_IDX 
							AND PUC.COUP_USE_YN  = 'N'
							AND PUC.DEL_USE_YN  = 'N'
							AND PC.COUP_USE_YN = 'Y'
							AND PCD.DATA_USE_YN  = 'Y'
							AND PUC.USER_IDX = #{frontLoginIdx}
							-- AND DATE_FORMAT(NOW(), '%Y-%m-%d') <= DATE_FORMAT( DATE_ADD( PUC.SYS_REG_DTM, INTERVAL PC.COUP_USE_DATE DAY ) , '%Y-%m-%d' )  	
		 
		]]>
	</select>
	
	<!-- 찜일때 같은 장바구니에서 같은상품인덱스 , 장바구니일때 찜목록에서 같은 상품인덱스 가져오기 -->
	<select id="selectFrontUserBaskOther" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			
			 
		
				SELECT
					PPB.BASK_IDX,
					PPB2.BASK_USE_YN JJIM_USE_YN,
					PPB2.BASK_IDX JJIM_IDX
					
				FROM
					PPM_PRDT_BASK PPB, PPM_PRDT_BASK PPB2
					where 
						PPB2.BASK_TYPE != #{baskType}
						AND PPB2.BASK_PRDT_CD = PPB.BASK_PRDT_CD
						AND PPB2.USER_IDX = PPB.USER_IDX
						AND PPB.BASK_TYPE = #{baskType}
						AND PPB.BASK_IDX = #{baskIdx}
					
						LIMIT 1
						
						
		 
		]]>
	</select>
	
	<update id="updateFrontMypageRefundApp" parameterType="hashmap">
		<![CDATA[
				UPDATE
						PPM_USER_BUY
							SET BUY_REFU_YN = 'R',
							SYS_MOD_DTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
								
								WHERE 
									BUY_IDX = #{buyIdx}
		]]>
	</update>

	<update id="updateFrontMypageRefundData" parameterType="hashmap">
		<![CDATA[
				UPDATE
						PPM_USER_BUY
							SET BUY_REFU_YN = 'Y',
							BUY_STAT = #{cancleBuyStat},
							SYS_MOD_DTM = DATE_FORMAT(NOW(), '%Y%m%d%H%i%S')
								
								WHERE 
									BUY_IDX = #{buyIdx}
		]]>
	</update>

	<select id="selectFrontMypageRefundInfo" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				SELECT
					DISTINCT
						BUY_IDX,
						PPM_USER_BUY.CATE_IDX,
						USER_IDX,
						(SELECT USER_NICK FROM PPM_USER PU WHERE USER_IDX = PPM_USER_BUY.USER_IDX) USER_NICK,
						(SELECT USER_EMAIL FROM PPM_USER PU2 WHERE USER_IDX = PPM_USER_BUY.USER_IDX) USER_EMAIL,
						TIME_IDX,
						IFNULL(COUP_IDX , "") COUP_IDX,
						
						(SELECT PC.COUP_IDX FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) REAL_COUP_IDX,
						
						BUY_PRDT_CD,
						BUY_CD,
						BUY_ORDER_NUMBER,
						BUY_NO,
						BUY_TYPE,
						BUY_PRIC,
						PRDT.PRDT_PRIC_REAL,
						
						(SELECT

						CAST(SUM(PRDT.PRDT_PRIC_REAL) AS CHAR) PRDT_PRIC_REAL
						
					FROM
						PPM_USER_BUY,
					(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, PPF.FACE_NM AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
	
						FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE PSF.FACE_IDX = PPF.FACE_IDX
					UNION ALL
						SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, PPLE.LECT_NM AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE  PSLE.LECT_IDX = PPLE.LECT_IDX
					UNION ALL
						SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, PPC.CHAT_NM AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE  PSC.CHAT_IDX = PPC.CHAT_IDX
					UNION ALL
						SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, PPM.MAIL_NM AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE  PSM.MAIL_IDX = PPM.MAIL_IDX
					UNION ALL
						SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, PPLI.LIVE_NM AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
								
								WHERE 
									PRDT.PRDT_CD = PPM_USER_BUY.BUY_PRDT_CD 
									AND BUY_NO = #{buyNo} ) PRDT_PRIC_REAL_ALL,
						
						
						(SELECT COUNT(0)+1 FROM PPM_USER_BUY B2 WHERE B2.BUY_NO = #{buyNo}  AND B2.BUY_STAT = '취소완료' ) PRDT_CANC_CNT,
						
						(SELECT PC.COUP_DISC FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) DISC,
						
						(SELECT PC.COUP_DISC_CD FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) DISC_CD,
									
						BUY_ACCO_NO,
						BUY_BANK_CD,
						BUY_COMP_YN,
						BUY_STAT,
						DATE_FORMAT(BUY_COMP_DTM, '%Y-%m-%d %H:%i:%S') BUY_COMP_DTM,
						BUY_REFU_YN,
						CASH_RECEIPT,
						CASH_RECE_WHY,
						CASH_RECE_SID,
						CASH_RECE_KIND,
						CASH_RECE_NO,
						SYS_REG_IDX,
						DATE_FORMAT(SYS_REG_DTM, '%Y%m%d%H%i%S') SYS_REG_DTM,
						SYS_MOD_IDX,
						DATE_FORMAT(SYS_MOD_DTM, '%Y%m%d%H%i%S') SYS_MOD_DTM
					FROM
						PPM_USER_BUY,
					(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, PPF.FACE_NM AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
	
						FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE PSF.FACE_IDX = PPF.FACE_IDX
					UNION ALL
						SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, PPLE.LECT_NM AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE  PSLE.LECT_IDX = PPLE.LECT_IDX
					UNION ALL
						SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, PPC.CHAT_NM AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE  PSC.CHAT_IDX = PPC.CHAT_IDX
					UNION ALL
						SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, PPM.MAIL_NM AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE  PSM.MAIL_IDX = PPM.MAIL_IDX
					UNION ALL
						SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, PPLI.LIVE_NM AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE  PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
								
								WHERE 
									PRDT.PRDT_CD = PPM_USER_BUY.BUY_PRDT_CD 
									AND BUY_NO = #{buyNo}
									
		]]>
	</select>

	<select id="selectFrontMypageRefundInfoAllCnt" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				SELECT
						COUNT(*) CNT						
						
					FROM
						PPM_USER_BUY
								WHERE 
									
									 BUY_NO = #{buyNo} 
														
									
		]]>
	</select>

	<select id="selectFrontMypageRefundInfoOne" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
				SELECT
					DISTINCT
						BUY_IDX,
						PPM_USER_BUY.CATE_IDX,
						USER_IDX,
						(SELECT USER_NICK FROM PPM_USER PU WHERE USER_IDX = PPM_USER_BUY.USER_IDX) USER_NICK,
						(SELECT USER_EMAIL FROM PPM_USER PU2 WHERE USER_IDX = PPM_USER_BUY.USER_IDX) USER_EMAIL,
						TIME_IDX,
						IFNULL(COUP_IDX , "") COUP_IDX,
						(SELECT PC.COUP_IDX FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) REAL_COUP_IDX,
						BUY_PRDT_CD,
						BUY_CD,
						BUY_ORDER_NUMBER,
						BUY_NO,
						BUY_TYPE,
						BUY_PRIC,
						PRDT.PRDT_PRIC_REAL,
						
						(SELECT

						CAST(SUM(PRDT.PRDT_PRIC_REAL) AS CHAR) PRDT_PRIC_REAL
						
					FROM
						PPM_USER_BUY,
					(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, PPF.FACE_NM AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
	
						FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE  PSF.FACE_IDX = PPF.FACE_IDX
					UNION ALL
						SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, PPLE.LECT_NM AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE PSLE.LECT_IDX = PPLE.LECT_IDX
					UNION ALL
						SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, PPC.CHAT_NM AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE PSC.CHAT_IDX = PPC.CHAT_IDX
					UNION ALL
						SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, PPM.MAIL_NM AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE  PSM.MAIL_IDX = PPM.MAIL_IDX
					UNION ALL
						SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, PPLI.LIVE_NM AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
								
								WHERE 
									PRDT.PRDT_CD = PPM_USER_BUY.BUY_PRDT_CD 
									AND BUY_NO = #{buyNo} ) PRDT_PRIC_REAL_ALL,
						
						
						(SELECT COUNT(0)+1 FROM PPM_USER_BUY B2 WHERE B2.BUY_NO = #{buyNo} AND B2.BUY_STAT = '취소완료' ) PRDT_CANC_CNT,
						
						(SELECT PC.COUP_DISC FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) DISC,
						
						(SELECT PC.COUP_DISC_CD FROM PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC WHERE 
									 PPM_USER_BUY.COUP_IDX = PUC.COUP_IDX
									AND PUC.DATA_IDX  = PCD.DATA_IDX 
									AND PCD.COUP_IDX  = PC.COUP_IDX ) DISC_CD,
									
						BUY_ACCO_NO,
						BUY_BANK_CD,
						BUY_COMP_YN,
						BUY_STAT,
						DATE_FORMAT(BUY_COMP_DTM, '%Y-%m-%d %H:%i:%S') BUY_COMP_DTM,
						BUY_REFU_YN,
						CASH_RECEIPT,
						CASH_RECE_WHY,
						CASH_RECE_SID,
						CASH_RECE_KIND,
						CASH_RECE_NO,
						SYS_REG_IDX,
						DATE_FORMAT(SYS_REG_DTM, '%Y%m%d%H%i%S') SYS_REG_DTM,
						SYS_MOD_IDX,
						DATE_FORMAT(SYS_MOD_DTM, '%Y%m%d%H%i%S') SYS_MOD_DTM
					FROM
						PPM_USER_BUY,
					(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, PPF.FACE_CD AS PRDT_CD, PPF.FACE_NM AS PRDT_NM, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_IMG_UUID AS PRDT_UUID, 'FACE_IMG_UUID' AS PRDT_UUID_NM
	
						FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE  PSF.FACE_IDX = PPF.FACE_IDX
					UNION ALL
						SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_CD AS PRDT_CD, PPLE.LECT_NM AS PRDT_NM, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_UUID AS PRDT_UUID, 'LECT_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE  PSLE.LECT_IDX = PPLE.LECT_IDX
					UNION ALL
						SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, PPC.CHAT_CD AS PRDT_CD, PPC.CHAT_NM AS PRDT_NM, CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_IMG_UUID AS PRDT_UUID, 'CHAT_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE PSC.CHAT_IDX = PPC.CHAT_IDX
					UNION ALL
						SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, PPM.MAIL_CD AS PRDT_CD, PPM.MAIL_NM AS PRDT_NM, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_IMG_UUID AS PRDT_UUID, 'MAIL_IMG_UUID' AS PRDT_UUID_NM
						FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE PSM.MAIL_IDX = PPM.MAIL_IDX
					UNION ALL
						SELECT '라이브클래스' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, PPLI.LIVE_CD AS PRDT_CD, PPLI.LIVE_NM AS PRDT_NM, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_IMG_UUID AS PRDT_UUID, 'LIVE_IMG_UUID' AS PRDT_UUID_NM
		
						FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE  PSLI.LIVE_IDX = PPLI.LIVE_IDX
					) PRDT
								
								WHERE 
									PRDT.PRDT_CD = PPM_USER_BUY.BUY_PRDT_CD 
									AND BUY_NO = #{buyNo}
									
									LIMIT 1
									
		]]>
	</select>
	
	<update id="updateCancleCoupData" parameterType="hashmap">
		<![CDATA[
		UPDATE
			 PPM_USER_COUP 
			 SET COUP_USE_YN = 'N'
			
				 WHERE COUP_IDX = #{coupIdx};
		]]>
	</update>
	
	
	
	
	<select id="selectFrontPrdtBuyDetail" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	SELECT
		PRDT.CATE_IDX,
		PRDT.PRDT_CD,
		INFO_PRDT_TITL1,
		INFO_PRDT_TITL2,
		PU.USER_NM ,
		P_CODE.CODE_NM AS P_CODE_NM,
		M_CODE.CODE_NM AS M_CODE_NM,
		(
			CASE
				WHEN PRDT.PRDT_CD LIKE '%VL%' THEN ( SELECT LECT_DTM FROM PPM_PRDT_LECT WHERE LECT_CD = PRDT.PRDT_CD )
				WHEN PRDT.PRDT_CD LIKE '%EN%' THEN ( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD )
				WHEN PRDT.PRDT_CD LIKE '%FN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE FACE_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
				WHEN PRDT.PRDT_CD LIKE '%CN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE CHAT_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
				WHEN PRDT.PRDT_CD LIKE '%LN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE LIVE_IDX = PRDT.PRDT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
			END
		) AS PRDT_CNT,
		
		( SELECT MAIL_DTM_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ) AS MAIL_DTM_CNT,
		
		(
			SELECT PPL.LECT_DTM FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'  AND PPL.LECT_USE_YN = 'Y' LIMIT 1
		) AS LECT_DTM,
		
		(
			SELECT COUNT(0) FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'
		) AS LECT_TOTAL_CNT,
		
		(
			SELECT SUM(DATA_RUNN) FROM PPM_PRDT_LECT PPL LEFT JOIN PPM_PRDT_LECT_DATA PPLD ON PPL.LECT_IDX = PPLD.LECT_IDX LEFT JOIN PPM_PRDT_VOD_DATA PPVD ON PPLD.VOD_IDX = PPVD.VOD_IDX
			WHERE LECT_CD = PRDT.PRDT_CD AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y'
		) AS LECT_TOTAL_MIN_CNT,
		
		DATE_FORMAT(NOW(), '%Y년 %m월 %d일') AS SYS_REG_DTM,
		(
			case WEEKDAY( NOW() ) 
			    when '0' then '월'
			    when '1' then '화'
			    when '2' then '수'
			    when '3' then '목'
			    when '4' then '금'
			    when '5' then '토'
			    when '6' then '일'
			END
		) AS SYS_REG_DTM_WEEK,
		FORMAT( PRDT_PRIC_REAL, 0 ) AS PRDT_PRIC_REAL
	FROM
		PPM_SALE_CD_VIEW PRDT
			LEFT JOIN PPM_CATE PC ON PRDT.CATE_IDX = PC.CATE_IDX
			LEFT JOIN PPM_USER PU ON PC.USER_IDX = PU.USER_IDX
			LEFT JOIN PPM_CODE P_CODE ON SUBSTR(PC.CODE_ID,1,5) = P_CODE.CODE_ID
			LEFT JOIN PPM_CODE M_CODE ON PC.CODE_ID = M_CODE.CODE_ID
			LEFT JOIN PPM_INFO_PRDT PIP ON PIP.CATE_IDX = PC.CATE_IDX
	WHERE
		PRDT.CATE_IDX IN ( SELECT CATE_IDX FROM PPM_CATE PC WHERE CATE_IDX = #{cateIdx } AND CATE_USE_YN = 'Y')
		AND PIP.INFO_USE_YN = 'Y'
		AND PIP.INFO_ORDE = '0'
		AND PRDT.PRDT_CD = #{prdtCd }
		AND PIP.INFO_PRDT_TITL1 = 
		CASE 
			WHEN #{prdtCd } LIKE '%LN%' OR #{prdtCd } LIKE '%VL%' THEN (SELECT PIP2.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP2 WHERE PIP2.PRDT_CD = #{prdtCd } AND PIP2.INFO_ORDE  = 0 AND PIP2.INFO_USE_YN= 'Y' ) 
			ELSE (SELECT PIP2.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP2 WHERE PIP2.PRDT_CD = CONCAT('COACHING', PRDT.CATE_IDX ) AND PIP2.INFO_ORDE  = 0 AND PIP2.INFO_USE_YN= 'Y' ) 
		END 
		]]>
	<if test="now not in { null, ''}">
		<![CDATA[
		AND REPLACE(PIP.PRDT_CD, 'COACHING','') = PC.CATE_IDX
		]]>
	</if>
	</select>
	
	<select id="selectFrontPrdtBuyTimeList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT
				TIME_IDX,
				LIVE_IDX,
				FACE_IDX,
				CHAT_IDX,
				DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) TIME_DTM,
				TIME_STR,
				(
					CASE
						WHEN #{prdtCd } LIKE '%FN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE FACE_IDX = FACE_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
						WHEN #{prdtCd } LIKE '%CN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE CHAT_IDX = CHAT_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
						WHEN #{prdtCd } LIKE '%LN%' THEN ( SELECT TIME_RUN FROM PPM_PRDT_TIME WHERE LIVE_IDX = LIVE_IDX ORDER BY TIME_IDX DESC LIMIT 1 )
					END
				) AS PRDT_CNT,
				(
					CASE WEEKDAY( TIME_DTM ) 
					    WHEN '0' THEN '월'
					    WHEN '1' THEN '화'
					    WHEN '2' THEN '수'
					    WHEN '3' THEN '목'
					    WHEN '4' THEN '금'
					    WHEN '5' THEN '토'
					    WHEN '6' THEN '일'
					END
				) AS TIME_DTM_WEEK,
				(SELECT COUNT(0) 
					FROM PPM_USER_BUY PUB 
					
						WHERE 
							PUB.TIME_IDX = PPM_PRDT_TIME.TIME_IDX 
							AND 
							(
								( DATEDIFF( NOW() ,PUB.SYS_REG_DTM ) < 3 AND PUB.BUY_STAT = '입금대기' ) 
								OR ( PUB.BUY_STAT = '결제완료' AND BUY_COMP_YN = 'Y' AND BUY_REFU_YN = 'N' )
							
							)
				) BUY_CNT,
				CASE 
					WHEN #{prdtCd } LIKE '%LN%' THEN (SELECT PPL.LIVE_CNT FROM PPM_PRDT_LIVE PPL WHERE PPL.LIVE_CD = #{prdtCd } )
					ELSE 'N'
				END LIVE_CNT	
				
			FROM	
				PPM_PRDT_TIME
			WHERE
				(
					CHAT_IDX = ( SELECT CHAT_IDX FROM PPM_PRDT_CHAT WHERE CHAT_CD = #{prdtCd } )
					OR LIVE_IDX = ( SELECT LIVE_IDX FROM PPM_PRDT_LIVE WHERE LIVE_CD = #{prdtCd } )
					OR FACE_IDX = ( SELECT FACE_IDX FROM PPM_PRDT_FACE WHERE FACE_CD = #{prdtCd } )
				)
				AND DATEDIFF(TIME_DTM, NOW()) >= 0
				AND TIME_USE_YN = 'Y'
				
				AND ( DATE_FORMAT(CONCAT( TIME_DTM, ' ' ,TIME_STR ), '%Y-%m-%d %H:%i') < DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') ) = 0 
				]]>
			<if test="timeDtm not in {null, ''}">
				<![CDATA[
				AND DATE_FORMAT( TIME_DTM, '%Y-%m-%d' ) = DATE_FORMAT(  #{timeDtm }, '%Y-%m-%d' )
				]]>
			</if>
		<![CDATA[
		
				
			ORDER BY
				TIME_DTM
			LIMIT 200
		]]>
	</select>
	
	<select id="selectFrontPrdtBuyQuesList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT
				QUES_IDX,
				QUES_CNTN
			FROM
				PPM_PRDT_QUES PPQ
			-- 		LEFT JOIN PPM_PRDT_QUES_DATA PPQD ON PPQ.QUES_IDX = PPQD.QUES_IDX
			WHERE
				(
					PPQ.CHAT_IDX = ( SELECT CHAT_IDX FROM PPM_PRDT_CHAT WHERE CHAT_CD = #{prdtCd } )
					OR PPQ.LIVE_IDX = ( SELECT LIVE_IDX FROM PPM_PRDT_LIVE WHERE LIVE_CD = #{prdtCd } )
					OR PPQ.FACE_IDX = ( SELECT FACE_IDX FROM PPM_PRDT_FACE WHERE FACE_CD = #{prdtCd } )
				)
				AND PPQ.QUES_USE_YN = 'Y'
			-- 	AND PPQD.DATA_USE_YN = 'Y'
			-- 	AND PPQD.USER_IDX = 4
			ORDER BY
				PPQ.QUES_IDX
		]]>
	</select>
	

	<insert id="insertFrontPrdtQuesData" parameterType="hashmap">
	<![CDATA[
		INSERT INTO
			PPM_PRDT_QUES_DATA
			(
				QUES_IDX, 
				USER_IDX, 
				DATA_CNTN,
				DATA_USE_YN, 
				
				SYS_REG_IDX, 
				SYS_REG_DTM, 
				SYS_MOD_IDX, 
				SYS_MOD_DTM
			) VALUES (
				#{quesIdx}, 
				#{frontLoginIdx}, 
				#{dataCntn}, 
				'Y', 
				
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S'), 
				#{frontLoginIdx}, 
				DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%S')
			)
		]]>
	</insert>
	
	<insert id="insertFrontJjimDataDuple" parameterType="hashmap">
		<![CDATA[
			INSERT INTO 
				PPM_PRDT_BASK
				(
				BASK_PRDT_CD,
				USER_IDX,
				CATE_IDX, 
				BASK_TYPE, 
				BASK_USE_YN,
				BASK_CNT,
				SYS_REG_IDX, 
				SYS_REG_DTM,
				SYS_MOD_IDX,
				SYS_MOD_DTM
				)
				VALUES(
				#{baskPrdtCd}, 
				#{frontLoginIdx}, 
				#{cateIdx},
				#{baskType}, 
				'Y',
				#{baskCnt},
				#{frontLoginIdx}, 
				DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' ),
				#{frontLoginIdx}, 
				DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' )
				)
		]]>
	</insert>

	<update id="updateFrontJjimData" parameterType="hashmap">
		<![CDATA[
			UPDATE  
				PPM_PRDT_BASK
				SET
					BASK_USE_YN = #{baskUseYn},	
					BASK_CNT = #{baskCnt},
					SYS_MOD_IDX = #{frontLoginIdx},
					SYS_MOD_DTM = DATE_FORMAT( NOW(), '%Y-%m-%d %H:%i:%S' )
					WHERE
						BASK_PRDT_CD = #{baskPrdtCd}
						AND CATE_IDX = #{cateIdx}
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = #{baskType}
						AND SYS_REG_IDX = #{frontLoginIdx}
		
		]]>
	</update>
	
<!-- 결제   --> 
<select id="selectFrontPaymentList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		SELECT
				*
			FROM (
			
					SELECT
					
					PRDT.PRDT_CD,
					CONCAT( PRDT.PRDT_NM1, ' ',PRDT.PRDT_NM2 )  AS PRDT_NM,
					PRDT_NM1,
					PRDT_NM2,
					( SELECT USER_NM FROM PPM_USER WHERE USER_IDX = ( SELECT USER_IDX FROM PPM_CATE WHERE CATE_IDX = PRDT.CATE_IDX ) ) AS USER_NM,
					( SELECT CATE_SLOG FROM PPM_CATE WHERE CATE_IDX = PRDT.CATE_IDX ) AS CATE_SLOG,
					PRDT.PRDT_TYPE,
					
					(
						CASE PRDT_TYPE
							WHEN '1:1화상상담' THEN ''
							WHEN 'VOD' THEN 
												CONCAT(CONVERT((
													SELECT COUNT(0) FROM PPM_PRDT_LECT_DATA PPLD, PPM_PRDT_VOD_DATA PPVD
													WHERE PPLD.LECT_IDX = PRDT.PRDT_IDX AND PPLD.VOD_IDX = PPVD.VOD_IDX AND PPLD.DATA_USE_YN = 'Y' AND PPVD.DATA_USE_YN = 'Y' 
												), CHAR), ' 개')
							WHEN '1:1채팅상담' THEN ''
							WHEN '1:1이메일상담' THEN CONCAT(( SELECT MAIL_CNT FROM PPM_PRDT_MAIL WHERE MAIL_CD = PRDT.PRDT_CD ), ' 건')
							WHEN '라이브클래스' THEN ''
						END
					) AS PRDT_CNT,
					
					FORMAT(PRDT_PRIC , 0) AS PRDT_PRIC,
					FORMAT(PRDT_PRIC_REAL , 0) AS PRDT_PRIC_REAL,
					PRDT_PRIC AS PRDT_PRIC_NOCOMMA,
					PRDT_PRIC_REAL AS PRDT_PRIC_REAL_NOCOMMA,
					
					PRDT.TIME_IDX,
					PRDT_TIME,
					PRDT.CATE_IDX,
					(SELECT PC2.CODE_NM FROM PPM_CODE PC2 WHERE  PC2.CODE_PARENT_IDX = 0 AND SUBSTR( PC2.CODE_ID, 1, 5 ) = SUBSTR( PC.CODE_ID, 1, 5 )  ) P_CODE_NM ,
					
					(
						CASE
							WHEN PRDT_CD LIKE '%VL%' THEN CONCAT(  PRDT.PRDT_TIME, '일' ) 
							WHEN PRDT_CD LIKE '%FN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
							WHEN PRDT_CD LIKE '%CN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
							WHEN PRDT_CD LIKE '%EN%' THEN CONCAT(   PRDT.PRDT_TIME, '회' ) 
							WHEN PRDT_CD LIKE '%LN%' THEN CONCAT(   PRDT.PRDT_TIME, '분' ) 
						END 
					) AS PRDT_USE_DTM,
					
					(SELECT PIP.INFO_TUMB_UUID 
						FROM PPM_INFO_PRDT PIP 
						WHERE 
							PIP.CATE_IDX = PRDT.CATE_IDX
							AND 
							PIP.PRDT_CD = (
								CASE 
									WHEN INSTR(PIP.PRDT_CD,'COACHING') = 1 THEN CONCAT('COACHING',PRDT.CATE_IDX) 
									ELSE PIP.PRDT_CD
								END	
							)
							AND PIP.INFO_ORDE = '0'
							AND PIP.INFO_USE_YN = 'Y'
						
							ORDER BY PIP.INFO_IDX DESC 
							LIMIT 1
						
					) AS PRDT_UUID,
					'INFO_TUMB_UUID_FILE' AS PRDT_UUID_NM
				FROM
					PPM_CATE PC,
					PPM_USER PU,
					(
					SELECT '1:1화상상담' AS PRDT_TYPE, PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, 
						IFNULL ( (SELECT TIME_IDX FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1 ), '' ) AS TIME_IDX , 
						
						(SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC 
				        FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'VOD' AS PRDT_TYPE, PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, '' AS TIME_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1채팅상담' AS PRDT_TYPE, PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, 
				        IFNULL ( (SELECT TIME_IDX FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1 ), '' ) AS TIME_IDX , 
				       
				        (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT '1:1이메일상담' AS PRDT_TYPE, PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, '' AS TIME_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,',', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'LIVE CLASS' AS PRDT_TYPE, PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, 
				        IFNULL ( (SELECT TIME_IDX FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1 ), '' ) AS TIME_IDX ,  
				       
				        (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' AND PPT.TIME_IDX IN (${timeIdx}) ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
					) PRDT
					
				WHERE
					
					PRDT.CATE_IDX = PC.CATE_IDX
					AND PC.USER_IDX = PU.USER_IDX
					AND PRDT.PRDT_CD IN (${baskArr})
				) MAIN
		]]>
</select>	
	
<select id="selectUserPrdtCoupList" parameterType="hashmap" resultType="hashmap">
<![CDATA[
	 SELECT 
			PUC.COUP_IDX ,
			PUC.DATA_IDX ,
			PUC.USER_IDX ,
			DATE_FORMAT( PUC.SYS_REG_DTM , '%Y-%m-%d') SYS_REG_DTM,
			PCD.COUP_DATA_CD ,
			
			(SELECT CODE_NM FROM PPM_CODE PC WHERE PC.CODE_ID = PC.COUP_DISC_CD) COUP_DISC_CD_NM,
			PC.COUP_NM ,
			PC.COUP_DISC ,
			PC.COUP_DISC_CD ,
			
			DATE_FORMAT( PC.COUP_END_DTM , '%Y-%m-%d') COUP_END_DTM,
			PC.COUP_MINI ,
			PC.COUP_MINI_TYPE ,
			PC.COUP_CATE_CD ,
			PC.COUP_SERV_CD,
			PC.COUP_CATE_CD,
			
			DATE_FORMAT( PC.COUP_STR_DTM , '%Y-%m-%d') COUP_STR_DTM,
			PC.COUP_UUID ,
			DATE_FORMAT( DATE_ADD( PUC.SYS_REG_DTM, INTERVAL PC.COUP_USE_DATE DAY ) , '%Y-%m-%d' ) COUP_END_DATE ,
			PUC.SYS_REG_DTM COUP_GET_DATE
				FROM
					PPM_USER_COUP PUC , PPM_COUP_DATA PCD , PPM_COUP PC
					
						WHERE
							PUC.DATA_IDX  = PCD.DATA_IDX 
							AND PCD.COUP_IDX  = PC.COUP_IDX 
							AND PUC.COUP_USE_YN  = 'N'
							AND PUC.COUP_DEL_YN = 'N'
							AND PC.COUP_USE_YN = 'Y'
							AND PCD.DATA_USE_YN  = 'Y'
							AND PUC.USER_IDX = #{frontLoginIdx}
						 	-- AND DATE_FORMAT(NOW(), '%Y-%m-%d') <= DATE_FORMAT( DATE_ADD( PUC.SYS_REG_DTM, INTERVAL PC.COUP_USE_DATE DAY ) , '%Y-%m-%d' )  	
						 	AND DATEDIFF( DATE_ADD( DATE_FORMAT(PUC.SYS_REG_DTM, '%Y-%m-%d') , INTERVAL PC.COUP_USE_DATE DAY ) , NOW()) > 0
	
]]>
</select>
	
<select id="selectUsePrdtList" parameterType="hashmap" resultType="hashmap">
<![CDATA[
	SELECT 
	PRDT.*,
	PC.CODE_ID ,
	(SELECT CODE_NM FROM PPM_CODE WHERE PPM_CODE.CODE_ID = PC.CODE_ID) CODE_NM,
	(SELECT CODE_NM FROM PPM_CODE WHERE PPM_CODE.CODE_ID = SUBSTRING( PC.CODE_ID, 1,5 ))  P_CODE_NM
	FROM 
		PPM_CATE PC ,
					(
						SELECT 'PRD03' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC 
				  	    FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD06' AS PRDT_TYPE, '' AS PRDT_TYPE2 , PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD02' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD04' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,',', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD05' AS PRDT_TYPE, '' AS PRDT_TYPE2 , PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
					) PRDT
		WHERE 
			PC.CATE_IDX = PRDT.CATE_IDX 
			AND PRDT_CD = #{prdtCd}
]]>
</select>

<select id="selectUsePrdtInfo" parameterType="hashmap" resultType="hashmap">
<![CDATA[
	SELECT 
	PRDT.*,
	PC.CODE_ID ,
	(SELECT CODE_NM FROM PPM_CODE WHERE PPM_CODE.CODE_ID = PC.CODE_ID) CODE_NM,
	(SELECT CODE_NM FROM PPM_CODE WHERE PPM_CODE.CODE_ID = SUBSTRING( PC.CODE_ID, 1,5 ))  P_CODE_NM
	FROM 
		PPM_CATE PC ,
					(
						SELECT 'PRD03' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSF.CATE_IDX, PSF.FACE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.FACE_IDX = PPF.FACE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPF.FACE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPF.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, FACE_PRIC_REAL AS PRDT_PRIC_REAL, FACE_PRIC AS PRDT_PRIC 
				  	    FROM PPM_SALE_FACE PSF, PPM_PRDT_FACE PPF WHERE SALE_USE_YN = 'Y' AND PSF.FACE_IDX = PPF.FACE_IDX AND PPF.FACE_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD06' AS PRDT_TYPE, '' AS PRDT_TYPE2 , PSLE.CATE_IDX, PSLE.LECT_IDX AS PRDT_IDX, PPLE.LECT_DTM AS PRDT_TIME, PPLE.LECT_CD AS PRDT_CD,(SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLE.LECT_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LECT_PRIC_REAL AS PRDT_PRIC_REAL, LECT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LECT PSLE, PPM_PRDT_LECT PPLE WHERE SALE_USE_YN = 'Y' AND PPLE.LECT_USE_YN = 'Y' AND PSLE.LECT_IDX = PPLE.LECT_IDX AND PPLE.LECT_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD02' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSC.CATE_IDX, PSC.CHAT_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN) FROM PPM_PRDT_TIME PPT WHERE PPT.CHAT_IDX = PPC.CHAT_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPC.CHAT_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPC.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2,  CHAT_PRIC_REAL AS PRDT_PRIC_REAL, CHAT_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_CHAT PSC, PPM_PRDT_CHAT PPC WHERE SALE_USE_YN = 'Y' AND PSC.CHAT_IDX = PPC.CHAT_IDX AND PPC.CHAT_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD04' AS PRDT_TYPE, 'PRD01' AS PRDT_TYPE2 , PSM.CATE_IDX, PSM.MAIL_IDX AS PRDT_IDX, CONCAT( DATE_FORMAT(PPM.MAIL_STR_DTM, '%Y-%m-%d' ), ' ~ ', DATE_FORMAT(PPM.MAIL_END_DTM, '%Y-%m-%d' ) ,',', PPM.MAIL_CNT ) AS PRDT_TIME, PPM.MAIL_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = CONCAT( 'COACHING', PPM.CATE_IDX ) AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, MAIL_PRIC_REAL AS PRDT_PRIC_REAL, MAIL_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_MAIL PSM, PPM_PRDT_MAIL PPM WHERE SALE_USE_YN = 'Y' AND PSM.MAIL_IDX = PPM.MAIL_IDX AND PPM.MAIL_USE_YN = 'Y'
				      UNION ALL
				        SELECT 'PRD05' AS PRDT_TYPE, '' AS PRDT_TYPE2 , PSLI.CATE_IDX, PSLI.LIVE_IDX AS PRDT_IDX, (SELECT CONCAT( PPT.TIME_DTM , ',', PPT.TIME_STR ,' ~ ', DATE_ADD( DATE_FORMAT( CONCAT(PPT.TIME_DTM, ',', PPT.TIME_STR), '%Y-%m-%d,%H:%i' ) , INTERVAL PPT.TIME_RUN MINUTE ),',',PPT.TIME_RUN)  FROM PPM_PRDT_TIME PPT WHERE PPT.LIVE_IDX = PPLI.LIVE_IDX AND PPT.TIME_USE_YN = 'Y' ORDER BY PPT.TIME_RUN LIMIT 1) AS PRDT_TIME, PPLI.LIVE_CD AS PRDT_CD, (SELECT PIP.INFO_PRDT_TITL1 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM1, (SELECT PIP.INFO_PRDT_TITL2 FROM PPM_INFO_PRDT PIP  WHERE  PIP.PRDT_CD = PPLI.LIVE_CD AND PIP.INFO_ORDE = 0 AND PIP.INFO_USE_YN = 'Y') AS PRDT_NM2, LIVE_PRIC_REAL AS PRDT_PRIC_REAL, LIVE_PRIC AS PRDT_PRIC
				        FROM PPM_SALE_LIVE PSLI, PPM_PRDT_LIVE PPLI WHERE SALE_USE_YN = 'Y' AND PSLI.LIVE_IDX = PPLI.LIVE_IDX AND PPLI.LIVE_USE_YN = 'Y'
					) PRDT
		WHERE 
			PC.CATE_IDX = PRDT.CATE_IDX 
]]>
</select>
	
<select id="selectUserBuyTimeIdx" parameterType="hashmap" resultType="hashmap">
<![CDATA[
	SELECT 
			(SELECT CONCAT( TIME_DTM, ' ', TIME_STR ) FROM PPM_PRDT_TIME PPT WHERE PPT.TIME_IDX = #{timeIdx} ) NO_TIME,	
			(SELECT CONCAT( PIP.INFO_PRDT_TITL1, ' ', PIP.INFO_PRDT_TITL2 ) FROM PPM_INFO_PRDT PIP 
				WHERE PIP.PRDT_CD = ( CASE 
				WHEN PUB.BUY_PRDT_CD LIKE '%CN%' THEN CONCAT( 'COACHING',PUB.CATE_IDX ) 
				WHEN PUB.BUY_PRDT_CD LIKE '%FN%' THEN CONCAT( 'COACHING',PUB.CATE_IDX ) 
				WHEN PUB.BUY_PRDT_CD LIKE '%LN%' THEN PUB.BUY_PRDT_CD
			END ) AND PIP.INFO_ORDE = 0 ) NO_TITL,
			
			(SELECT LIVE_CNT FROM PPM_PRDT_LIVE WHERE LIVE_CD = PUB.BUY_PRDT_CD ) LIVE_CNT

		
		FROM PPM_USER_BUY PUB 
			WHERE PUB.BUY_PRDT_CD = #{prdtCd} AND PUB.TIME_IDX = #{timeIdx}
			AND ( PUB.BUY_STAT = '결제완료' OR ( PUB.BUY_STAT = '입금대기' AND DATEDIFF( NOW(), PUB.SYS_REG_DTM ) < 3 ) )
]]>
</select>	
	
	
	<select id="selectFrontBaskData" parameterType="hashmap" resultType="hashmap"> 
	<![CDATA[
		SELECT  
				
				*
				
			FROM	
				PPM_PRDT_BASK
				
					WHERE
						BASK_PRDT_CD = ( SELECT BASK_PRDT_CD FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx} )
						AND CATE_IDX = ( SELECT CATE_IDX FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx} )
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = 'B'
						AND SYS_REG_IDX = #{frontLoginIdx}
	
		]]>
	</select>

	<select id="selectFrontBaskJjimData" parameterType="hashmap" resultType="hashmap"> 
	<![CDATA[
		SELECT  
				
				*
				
			FROM	
				PPM_PRDT_BASK
				
					WHERE
						BASK_PRDT_CD = ( SELECT BASK_PRDT_CD FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx} )
						AND CATE_IDX = ( SELECT CATE_IDX FROM PPM_PRDT_BASK WHERE BASK_IDX = #{baskIdx} )
						AND USER_IDX = #{frontLoginIdx}
						AND BASK_TYPE = 'K'
						AND SYS_REG_IDX = #{frontLoginIdx}
	
		]]>
	</select>
	
	<update id="updateNaverCashReceiptData" parameterType="hashmap">
		<![CDATA[
			UPDATE PPM_USER_BUY
				SET 
					CASH_RECEIPT = '1',
					CASH_RECEIPT_NM = #{cashReceiptNm},
					CASH_RECE_WHY = #{cashReceWhy},
					CASH_RECE_SID = #{cashReceSid},
					CASH_RECE_KIND = #{cashReceKind},
					CASH_RECE_NO = #{cashReceNo},
					SYS_MOD_IDX = #{frontLoginIdx}
				
				WHERE 
					BUY_IDX = #{buyIdx}
		]]>
	
	</update>
	
	<select id="selectFrontNPayData" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		SELECT
			BUY_IDX,
			CASH_RECEIPT,
			CASH_RECEIPT_NM ,
			CASH_RECE_WHY,
			CASH_RECE_SID,
			CASH_RECE_KIND,
			CASH_RECE_NO,
			
			IF( CASH_RECE_NO = NULL, 'NO', IF( TRIM(CASH_RECE_NO) != '', CASH_RECE_NO, 'NO' ) ) TRIMED_CASH_RECE_NO
			
			FROM
				PPM_USER_BUY
				
				WHERE 
					BUY_IDX = #{buyIdx}
					AND BUY_NO = #{buyNo}
					AND SYS_REG_IDX = #{frontLoginIdx}
	]]>
	</select>
	
	<select id="selectFrontJjimCoachPrdtCd" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
		SELECT
			CATE_IDX,
			PRDT_IDX,
			PRDT_CD
		
			FROM 
				PPM_SALE_CD_VIEW PSCV 
				WHERE 
				CATE_IDX = #{cateIdx}
				AND 
				( PRDT_CD LIKE '%CN%'
				OR PRDT_CD LIKE '%EN%'
				OR PRDT_CD LIKE '%FN%' )
		]]>
	</select>
	
	<update id="deleteEndDtmUserCoupData" parameterType="hashmap">
	<![CDATA[
		UPDATE PPM_USER_COUP SET COUP_DEL_YN = 'Y' WHERE COUP_IDX = #{coupIdx}
	]]>
	</update>
	
</mapper>
